FROM quay.io/centos/centos:stream8 as builder

ENV ROCKSDB_VERSION="v6.7.3"
ENV ZSTD_VERSION="1.4.4"

RUN yum update -y && yum install -y epel-release dnf-plugins-core && yum config-manager --set-enabled powertools

RUN yum -y groupinstall "Development Tools"
RUN yum install -y gflags snappy-devel zlib-devel bzip2-devel lz4-devel cmake which

RUN  curl -L https://github.com/facebook/zstd/archive/v${ZSTD_VERSION}.tar.gz | tar xzvf - -C /tmp && \
    mv /tmp/zstd-${ZSTD_VERSION} /tmp/zstd && \
    cd /tmp/zstd && make && make install

# This compiles RocksDB without BMI and AVX2 instructions
ENV PORTABLE=1 TRY_SSE_ETC=0 TRY_SSE42="-msse4.2" TRY_PCLMUL="-mpclmul" CXXFLAGS="-fPIC"

RUN cd /tmp && \
    git clone -b "${ROCKSDB_VERSION}" --depth 1 https://github.com/facebook/rocksdb.git && \
    cd rocksdb && \
    make static_lib

RUN cd /tmp/rocksdb && DEBUG_LEVEL=0 make ldb

RUN curl -L https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz | tar -xJf -
RUN upx-3.96-amd64_linux/upx -9 /tmp/rocksdb/ldb

FROM quay.io/centos/centos:stream8

ARG GOLANG_VERSION=1.17.2

RUN yum update -y && yum install -y epel-release dnf-plugins-core && yum config-manager --set-enabled powertools
RUN yum -y groupinstall "Development Tools"
RUN yum install -y snappy-devel zlib-devel bzip2-devel lz4-devel

RUN curl -L https://dl.google.com/go/go${GOLANG_VERSION}.linux-amd64.tar.gz | tar -C /usr/local -zxvf -

ENV GOPATH /go
ENV PATH $GOPATH/bin:/usr/local/go/bin:$PATH
RUN mkdir -p "$GOPATH/src" "$GOPATH/bin" && chmod -R 777 "$GOPATH"

COPY --from=builder /tmp/rocksdb/librocksdb.a /lib/rocksdb/librocksdb.a
COPY --from=builder /tmp/rocksdb/include /lib/rocksdb/include
COPY --from=builder /tmp/zstd /lib/zstd
COPY --from=builder /tmp/rocksdb/ldb /usr/local/bin/ldb

ENV CGO_CFLAGS="-I/lib/rocksdb/include -I/lib/zstd/lib"
ENV CGO_LDFLAGS="-L/lib/rocksdb -L/lib/zstd/lib -lrocksdb -lstdc++ -lm -lz -lbz2 -lsnappy -llz4 -lzstd"
ENV CGO_ENABLED=1
ENV GOCACHE="/linux-gocache"

WORKDIR /go/src/github.com/stackrox/rox
