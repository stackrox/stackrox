// This contains protobuf types in pair with ClairCore's types, with
// minimal differences. See https://github.com/quay/claircore for comments
// on the fields.

edition = "2023";  // successor to proto2 and proto3

package scanner.v4;

import "internalapi/scanner/v4/common.proto";
import "internalapi/scanner/v4/index_report.proto";
import "google/protobuf/go_features.proto";

option go_package = "./internalapi/scanner/v4;v4";
option features.(pb.go).api_level = API_OPAQUE;

// Provide information to retrieve container images and their layers.
message ContainerImageLocator {
  string url = 1;
  string username = 2;
  string password = 3;
  bool insecure_skip_tls_verify = 4;
}

message CreateIndexReportRequest {
  string hash_id = 1;
  oneof resource_locator {
    ContainerImageLocator container_image = 2;
  }
}

message GetIndexReportRequest {
  string hash_id = 1;
  bool includeExternal = 2;
}

message HasIndexReportRequest {
  string hash_id = 1;
}

message HasIndexReportResponse {
  bool exists = 1;
}

message GetOrCreateIndexReportRequest {
  string hash_id = 1;
  oneof resource_locator {
    ContainerImageLocator container_image = 2;
  }
}

message StoreIndexReportRequest {
  string hash_id = 1;
  string indexer_version = 2;
  Contents contents = 3;
}

message StoreIndexReportResponse {
  string status = 1;
}

// Indexer service creates manifests and store index reports.
service Indexer {
  // CreateIndexReport creates an index report for the specified resource and returns the report.
  rpc CreateIndexReport(CreateIndexReportRequest) returns (IndexReport);

  // GetIndexReport returns one index report.
  rpc GetIndexReport(GetIndexReportRequest) returns (IndexReport);

  // GetOrCreateIndexReport creates an index report for the specified resource,
  // if it does not already exist, and returns the report.
  // This essentially combines GetIndexReport and CreateIndexReport.
  rpc GetOrCreateIndexReport(GetOrCreateIndexReportRequest) returns (IndexReport);

  // HasIndexReport checks if an index report for the specified resource exists.
  rpc HasIndexReport(HasIndexReportRequest) returns (HasIndexReportResponse);

  // StoreIndexReport stores an external index report to the datastore.
  rpc StoreIndexReport(StoreIndexReportRequest) returns (StoreIndexReportResponse);
}
