syntax = "proto3";

package v1;

import weak "google/api/annotations.proto";
import "storage/deployment.proto";

option go_package = "./api/v1;v1";
option java_package = "io.stackrox.proto.api.v1";

// RiskService provides APIs for managing deployment risk rankings
service RiskService {
  // ChangeDeploymentRiskPosition adjusts a deployment's risk ranking
  // by calculating effective score as average of neighbor deployments
  rpc ChangeDeploymentRiskPosition(RiskPositionChangeRequest) returns (RiskAdjustmentResponse) {
    option (google.api.http) = {
      post: "/v1/risk/deployment/{deployment_id}/position"
      body: "*"
    };
  }

  // ResetDeploymentRisk removes user ranking adjustments and returns to the original ML-calculated score
  rpc ResetDeploymentRisk(RiskAdjustmentRequest) returns (RiskAdjustmentResponse) {
    option (google.api.http) = {
      post: "/v1/risk/deployment/{deployment_id}/reset"
      body: "*"
    };
  }

  // ResetAllDeploymentRisks removes all user ranking adjustments for all deployments
  rpc ResetAllDeploymentRisks(ResetAllRisksRequest) returns (ResetAllRisksResponse) {
    option (google.api.http) = {
      post: "/v1/risk/deployment/reset-all"
      body: "*"
    };
  }
}

message RiskPositionChangeRequest {
  // Deployment ID to adjust
  string deployment_id = 1;
  // Deployment ID directly above new position (null if moved to top)
  string above_deployment_id = 2;
  // Deployment ID directly below new position (null if moved to bottom)
  string below_deployment_id = 3;
}

message RiskAdjustmentRequest {
  // Deployment ID to reset
  string deployment_id = 1;
}

message ResetAllRisksRequest {}

message ResetAllRisksResponse {
  // Number of deployments that had adjustments reset
  int32 count = 1;
  // Human-readable message about the operation
  string message = 2;
}

message RiskAdjustmentResponse {
  // Updated deployment with new ranking adjustment
  storage.Deployment deployment = 1;
  // Original ML-calculated risk score
  float original_score = 2;
  // Effective risk score (user-adjusted or ML score)
  float effective_score = 3;
  // Human-readable message about the adjustment
  string message = 4;
}
