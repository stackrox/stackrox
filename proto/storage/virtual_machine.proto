syntax = "proto3";

package storage;

import "storage/cve.proto";
import "google/protobuf/timestamp.proto";

// TODO (ROX-30352): Review this whole proto for GA readiness.  Lots of copypasta.
message VirtualMachine {
  string id = 1; // @gotags: sql:"pk,type(uuid)" search:"Virtual Machine ID,store"
  string namespace = 2; // @gotags: search:"Namespace,store"
  string name = 3; // @gotags: search:"Virtual Machine Name,store"
  string cluster_id = 4; // @gotags: search:"Cluster ID,hidden,store"  sql:"type(uuid)"
  string cluster_name = 5;
  map<string, string> facts = 6;

  google.protobuf.Timestamp last_updated = 7;

  enum Note {
    MISSING_METADATA = 0;
    MISSING_SCAN_DATA = 1;
    MISSING_SIGNATURE = 2;
    MISSING_SIGNATURE_VERIFICATION_DATA = 3;
  }
  repeated Note notes = 8;

  int32 vsock_cid = 9;
  enum State {
    UNKNOWN = 0;
    STOPPED = 1;
    RUNNING = 2;
  }
  State state = 10;

  VirtualMachineScan scan = 11;
}

message VirtualMachineScan {
  google.protobuf.Timestamp scan_time = 1;
  string operating_system = 2;
  enum Note {
    UNSET = 0;
  }
  repeated Note notes = 3;
  repeated EmbeddedVirtualMachineScanComponent components = 4;
}

message EmbeddedVirtualMachineScanComponent {
  string name = 1;
  string version = 2;
  oneof set_top_cvss {
    float top_cvss = 3;
  }
  float risk_score = 4;
  repeated VirtualMachineVulnerability vulnerabilities = 5;
}

message VirtualMachineVulnerability {
  VirtualMachineCVEInfo cve_base_info = 1;
}

// VirtualMachineCVEInfo is a clone of the CVEInfo message from cve.proto, stripped from its search tags
message VirtualMachineCVEInfo {
  message Reference {
    string URI = 1;
    repeated string tags = 2;
  }
  // ScoreVersion can be deprecated ROX-26066
  enum ScoreVersion {
    V2 = 0; // No unset for automatic backwards compatibility
    V3 = 1;
    UNKNOWN = 2;
  }
  string cve = 1;
  string summary = 2;
  string link = 3;
  // This indicates the timestamp when the cve was first published in the cve feeds.
  google.protobuf.Timestamp published_on = 4;
  // Time when the CVE was first seen in the system.
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp last_modified = 6;
  ScoreVersion score_version = 7;
  // CVSSV2 CVSSV3 ScoreVersion can be deprecated ROX-26066
  CVSSV2 cvss_v2 = 8;
  CVSSV3 cvss_v3 = 9;
  repeated Reference references = 10;

  // cvss_metrics stores list of cvss scores from different sources like nvd, Redhat etc
  repeated CVSSScore cvss_metrics = 11;
  VirtualMachineEPSS epss = 12;
}


// VirtualMachineEPSS Score stores two epss metrics returned by scanner - epss probability and epss percentile
// This structure is a clone of the EPSS message from cve.proto, stripped from its search tags.
message VirtualMachineEPSS {
  float epss_probability = 1;
  float epss_percentile = 2;
}
