# Manifest to Central CR Converter

This Go program converts StackRox manifests generated by `roxctl central generate` back into Central Custom Resource YAML files that can be used with the StackRox Operator.

## Features

### Input Sources
The program supports multiple input sources:

1. **YAML Files**: Individual manifest files
2. **Directories**: Recursively scans for `.yaml` and `.yml` files
3. **Kubernetes Namespaces**: Fetches live resources from a running cluster using `--namespace` flag
4. **stdin**: For piping input

### Command Line Interface
- `--namespace <namespace>`: Fetch resources from specified Kubernetes namespace
- `--help`: Show help message
- Positional arguments: File and directory paths

### Kubernetes Integration
- Uses default kubeconfig (`~/.kube/config`) or `KUBECONFIG` environment variable
- Supports in-cluster configuration when running as a pod
- Fetches the following resource types from the specified namespace:
  - Deployments
  - Services
  - ConfigMaps
  - Secrets
  - PersistentVolumeClaims
  - Routes (OpenShift, when available)

### Conversion Capabilities
The program extracts and maps the following configurations:

- **Central Component**:
  - Resource requests/limits
  - Node selectors and tolerations
  - Environment variables (telemetry, offline mode)
  - Default TLS certificates

- **Scanner Component**:
  - Analyzer scaling (replicas)
  - Resource requests/limits

- **Exposure Settings**:
  - LoadBalancer (enabled, port, IP)
  - NodePort (enabled, port)
  - OpenShift Route (enabled, host)

- **Database Settings**:
  - External database connections
  - PVC persistence (claim name, storage class, size)

- **Other Settings**:
  - Telemetry configuration
  - Egress/connectivity policy (online/offline mode)

## Usage Examples

```bash
# From individual files
./manifest-to-cr-converter manifests.yaml
./manifest-to-cr-converter central.yaml scanner.yaml

# From directory (recursive)
./manifest-to-cr-converter ./manifests-dir/

# From Kubernetes namespace
./manifest-to-cr-converter --namespace stackrox

# From stdin
cat manifests.yaml | ./manifest-to-cr-converter
./manifest-to-cr-converter -

# Mixed sources (files/directories + namespace)
./manifest-to-cr-converter manifests.yaml ./more-manifests/ --namespace stackrox

# Help
./manifest-to-cr-converter --help
```

## Output

The program outputs a properly structured Central Custom Resource in YAML format that can be applied to a Kubernetes cluster with the StackRox Operator installed.

Example output structure:
```yaml
apiVersion: platform.stackrox.io/v1alpha1
kind: Central
metadata:
  name: stackrox-central-services
  namespace: stackrox
spec:
  central:
    exposure:
      loadBalancer:
        enabled: true
        port: 443
    resources:
      requests:
        memory: "4Gi"
        cpu: "1500m"
      limits:
        memory: "8Gi"
        cpu: "4000m"
    db:
      persistence:
        persistentVolumeClaim:
          claimName: central-db
          size: "100Gi"
          storageClassName: fast-ssd
  scanner:
    analyzer:
      scaling:
        replicas: 2
      resources:
        requests:
          memory: "1500Mi"
          cpu: "1000m"
        limits:
          memory: "4Gi"
          cpu: "2000m"
  egress:
    connectivityPolicy: Online
```

## Building

```bash
go build -o manifest-to-cr-converter manifest-to-cr-converter.go
```

## Dependencies

The program uses the following key dependencies:
- `k8s.io/client-go` - Kubernetes client library
- `k8s.io/api` - Kubernetes API types
- `github.com/stackrox/rox/operator/api/v1alpha1` - StackRox operator API types

## Important Notes

1. **Best-effort conversion**: This is a reverse-engineering process, so some settings may not be perfectly mapped
2. **Manual verification required**: Always review and test the generated CR before using in production
3. **Extensible design**: The program can be easily extended to handle additional resource types and configuration mappings
4. **Error handling**: The program handles missing files, invalid YAML, and Kubernetes connection issues gracefully

## Limitations

- Some advanced Helm template features may not be fully reverse-engineered
- OpenShift Route support is basic (more advanced route configurations may need manual adjustment)
- Scanner V4 support is not yet implemented
- Custom resource definitions and operators are not fetched from Kubernetes namespaces

## Migration Workflow

1. Generate manifests with roxctl: `roxctl central generate k8s pvc`
2. Convert to Central CR: `./manifest-to-cr-converter ./central-bundle/`
3. Review and adjust the generated CR as needed
4. Apply to cluster with operator: `kubectl apply -f central-cr.yaml`