import { generatePath } from 'react-router-dom';

import { SlimUser } from 'types/user.proto';
import { SearchFilter, ApiSortOption } from 'types/search';
import { getListQueryParams } from 'utils/searchUtils';
import { Empty } from './types';
import axios from './instance';

const baseUrl = '/v2/vulnerability-exceptions';

export type VulnerabilityState = 'OBSERVED' | 'DEFERRED' | 'FALSE_POSITIVE';

export type ExceptionStatus = 'PENDING' | 'APPROVED' | 'DENIED' | 'APPROVED_PENDING_UPDATE';

type Comment = {
    id: string;
    message: string;
    user: SlimUser;
    createdAt: string; // ISO 8601
};

export type VulnerabilityExceptionScope = {
    imageScope: {
        registry: string;
        remote: string;
        tag: string;
    };
};

type ExceptionExpiry =
    | {
          expiryType: 'TIME';
          expiresOn: string | null;
      }
    | {
          expiryType: 'ALL_CVE_FIXABLE' | 'ANY_CVE_FIXABLE';
      };

export type BaseVulnerabilityException = {
    id: string;
    name: string;
    exceptionStatus: ExceptionStatus;
    expired: boolean;
    requester: SlimUser;
    createdAt: string; // ISO 8601
    lastUpdated: string; // ISO 8601
    comments: Comment[];
    scope: VulnerabilityExceptionScope;
    cves: string[];
};

export type VulnerabilityDeferralException = BaseVulnerabilityException & {
    targetState: 'DEFERRED';
    deferralReq: {
        expiry: ExceptionExpiry;
    };
    deferralUpdate?: {
        cves: string[];
        expiry: ExceptionExpiry;
    };
};

export function isDeferralException(
    exception: BaseVulnerabilityException
): exception is VulnerabilityDeferralException {
    return 'targetState' in exception && exception.targetState === 'DEFERRED';
}

export type VulnerabilityFalsePositiveException = BaseVulnerabilityException & {
    targetState: 'FALSE_POSITIVE';
    fpRequest: Empty;
    falsePositiveUpdate?: {
        cves: string[];
    };
};

export function isFalsePositiveException(
    exception: BaseVulnerabilityException
): exception is VulnerabilityFalsePositiveException {
    return 'targetState' in exception && exception.targetState === 'FALSE_POSITIVE';
}

export function getVulnerabilityExceptionById(id: string): Promise<BaseVulnerabilityException> {
    const url = generatePath(`${baseUrl}/:id`, { id });
    return axios
        .get<{ exception: BaseVulnerabilityException }>(url)
        .then((response) => response.data.exception);
}

export function listVulnerabilityExceptions(
    searchFilter: SearchFilter,
    sortOption: ApiSortOption,
    page?: number,
    pageSize?: number
): Promise<(VulnerabilityDeferralException | VulnerabilityFalsePositiveException)[]> {
    const params = getListQueryParams(searchFilter, sortOption, page, pageSize);

    return axios
        .get<{
            exceptions: (VulnerabilityDeferralException | VulnerabilityFalsePositiveException)[];
        }>(`${baseUrl}?${params}`)
        .then((response) => response.data.exceptions);
}

export type CreateDeferVulnerabilityExceptionRequest = {
    cves: string[];
    comment: string;
    scope: VulnerabilityExceptionScope;
    exceptionExpiry: ExceptionExpiry;
};

export function createDeferralVulnerabilityException(
    payload: CreateDeferVulnerabilityExceptionRequest
): Promise<VulnerabilityDeferralException> {
    const url = `${baseUrl}/deferral`;
    return axios
        .post<{ exception: VulnerabilityDeferralException }>(url, payload)
        .then((response) => response.data.exception);
}
