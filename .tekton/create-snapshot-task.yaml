apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-snapshot
  namespace: rh-acs-tenant
spec:
  description: Creates snapshot
  params:
  - name: SOURCE_ARTIFACT
    description: The Trusted Artifact URI pointing to the application source code.
    type: string
  - name: IMAGE_REFS
    description: Image references.
    type: string
  volumes:
  - name: workdir
    emptyDir: { }
  stepTemplate:
    volumeMounts:
    - mountPath: /var/workdir
      name: workdir
  steps:
  - name: use-trusted-artifact
    image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:81c4864dae6bb11595f657be887e205262e70086a05ed16ada827fd6391926ac
    args:
    - use
    - $(params.SOURCE_ARTIFACT)=/var/workdir/source
  - name: create-snapshot
    image: registry.access.redhat.com/ubi9/ubi:latest
    workingDir: /var/workdir/source
    env:
      - name: APPLICATION
        valueFrom:
          fieldRef:
            fieldPath: metadata.labels['appstudio.openshift.io/application']
    script: |
      #!/usr/bin/env bash
      set -euo pipefail
      dnf -y upgrade --nobest
      dnf -y install jq


      echo "$(params.IMAGE_REFS)"

      echo "$(params.IMAGE_REFS)" | jq

      cat <<EOF > snapshot-template.json
      {
        "apiVersion": "appstudio.redhat.com/v1alpha1",
        "kind": "Snapshot",
        "metadata": {
          "name": "tm-$(date +%s)"
        },
        {
          "spec": {
            "application": "${APPLICATION}",
            "components": []
          }
        }
      }

      cat snapshot-template.json

      jq . snapshot-template.json
