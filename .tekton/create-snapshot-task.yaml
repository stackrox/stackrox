apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-snapshot
  namespace: rh-acs-tenant
spec:
  description: Creates a snapshot based on the component names, image refs and Git information passed to the task.
  params:
  - name: SOURCE_ARTIFACT
    description: The Trusted Artifact URI pointing to the application source code.
    type: string
  - name: COMPONENTS
    description: A stringified JSON array with information about components with name, container image ref, git repo and git revision for each.
    type: string
  - name: PRODUCT_VERSION
    description: Product version to record as part of the Snapshot's name to be able to identify snapshots more easily. Pass here the result from determine-image-tag for the main image.
    type: string
  results:
  - name: SNAPSHOT_NAME
    description: Name of the snapshot created by this task.
  volumes:
  - name: workdir
    emptyDir: { }
  stepTemplate:
    volumeMounts:
    - mountPath: /var/workdir
      name: workdir
  steps:
  - name: use-trusted-artifact
    image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:81c4864dae6bb11595f657be887e205262e70086a05ed16ada827fd6391926ac
    args:
    - use
    - $(params.SOURCE_ARTIFACT)=/var/workdir/source
  - name: render-snapshot
    image: registry.access.redhat.com/ubi9:latest@sha256:1057dab827c782abcfb9bda0c3900c0966b5066e671d54976a7bcb3a2d1a5e53
    workingDir: /var/workdir/source
    env:
      # These values must be provided as environment variables.
      # They cannot be provided as arguments to the Python script.
      - name: APPLICATION
        valueFrom:
          fieldRef:
            fieldPath: metadata.labels['appstudio.openshift.io/application']
      - name: NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
      - name: PIPELINE_RUN_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.labels['tekton.dev/pipeline']
      # TODO(when inline Python script): refactor below vars to args: attribute
      - name: COMPONENTS
        value: $(params.COMPONENTS)
      - name: PRODUCT_VERSION
        value: $(params.PRODUCT_VERSION)
      - name: SNAPSHOT_NAME_RESULT_PATH
        value: $(results.SNAPSHOT_NAME.path)
    script: .konflux/scripts/render_snapshot.py

  - name: create-snapshot
    image: registry.redhat.io/openshift4/ose-cli-rhel9@sha256:4f822262adc75bff1891bee0bab1611ae62dfb347f98fcf9aa2604129087eb2c
    workingDir: /var/workdir/source
    script: oc create -f snapshot.json
