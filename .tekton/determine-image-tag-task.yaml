apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: determine-image-tag
  namespace: rh-acs-tenant
spec:
  description: Determining image tag with custom logic.
  params:
  - name: image
    description: Image without tag
  results:
  - name: image-with-tag
    description: Fully Qualified Image Name with identifying tag
  steps:
  - name: determine-image-tag
    image: registry.access.redhat.com/ubi8:latest
    env:
      - name: IMAGE
        value: $(params.image)
    script: |
      #!/usr/bin/env bash
      set -euo pipefail
      dnf -y upgrade --nobest
      dnf -y install git make
      cd "$(workspaces.source.path)/source"
      echo -n "${IMAGE%%:*}:$(make --quiet --no-print-directory tag)-fast" | tee "$(results.image-with-tag.path)"
  workspaces:
    - name: source
      description: The workspace where source code is included.
