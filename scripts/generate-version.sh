#!/usr/bin/env bash

# Generate version_data_generated.go with version info from status.sh
# This replaces the ldflags approach to improve Go build cache efficiency.
# When version changes, only pkg/version/internal needs recompilation,
# not all packages that depend on it.

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="${SCRIPT_DIR}/.."

# Read version info from status.sh
declare -A versions
while read -r line || [[ -n "$line" ]]; do
    if [[ "$line" =~ ^[[:space:]]*$ ]]; then
        continue
    elif [[ "$line" =~ ^([^[:space:]]+)[[:space:]]+(.*)[[:space:]]*$ ]]; then
        var="${BASH_REMATCH[1]}"
        def="${BASH_REMATCH[2]}"
        versions["$var"]="$def"
    fi
done < <(cd "${ROOT_DIR}"; ./status.sh)

# Generate the Go file
OUTPUT_FILE="${ROOT_DIR}/pkg/version/internal/version_data_generated.go"

cat > "${OUTPUT_FILE}" << EOF
// Code generated by scripts/generate-version.sh. DO NOT EDIT.

package internal

func init() {
	MainVersion = "${versions[STABLE_MAIN_VERSION]}"
	CollectorVersion = "${versions[STABLE_COLLECTOR_VERSION]}"
	FactVersion = "${versions[STABLE_FACT_VERSION]}"
	ScannerVersion = "${versions[STABLE_SCANNER_VERSION]}"
	GitShortSha = "${versions[STABLE_GIT_SHORT_SHA]}"
}
EOF

echo "Generated ${OUTPUT_FILE}" >&2
