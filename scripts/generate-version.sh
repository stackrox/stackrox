#!/usr/bin/env bash

# Generate version_data_generated.go with version info.
# This replaces the ldflags approach to improve Go build cache efficiency.
# When version changes, only pkg/version/internal needs recompilation,
# not all packages that depend on it.
#
# Computes version values directly (avoiding 5 separate make calls via status.sh)
# for faster execution (~0.5s vs ~12s).

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="${SCRIPT_DIR}/.."

cd "${ROOT_DIR}"

# Compute version values directly (same logic as Makefile/status.sh)
# Use BUILD_TAG if set, otherwise use git describe
if [[ -n "${BUILD_TAG}" ]]; then
    MAIN_VERSION="${BUILD_TAG}"
else
    MAIN_VERSION="$(git describe --tags --abbrev=10 --dirty --long --exclude '*-nightly-*' 2>/dev/null || echo "0.0.0-unknown")"
fi

# Read component versions from files
COLLECTOR_VERSION="$(cat COLLECTOR_VERSION 2>/dev/null || echo "0.0.0")"
FACT_VERSION="$(cat FACT_VERSION 2>/dev/null || echo "0.0.0")"
SCANNER_VERSION="$(cat SCANNER_VERSION 2>/dev/null || echo "0.0.0")"

# Use SHORTCOMMIT if set, otherwise use git rev-parse
if [[ -n "${SHORTCOMMIT}" ]]; then
    GIT_SHORT_SHA="${SHORTCOMMIT}"
else
    GIT_SHORT_SHA="$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")"
fi

# Generate the Go file
OUTPUT_FILE="${ROOT_DIR}/pkg/version/internal/version_data_generated.go"
OUTPUT_DIR="$(dirname "${OUTPUT_FILE}")"

# Check if we can write to the output location
# In Docker builds, the file may already exist and we may not have write permissions
if [[ -f "${OUTPUT_FILE}" ]] && ! [[ -w "${OUTPUT_FILE}" ]]; then
    echo "Skipping version generation: ${OUTPUT_FILE} exists and is not writable (likely Docker build)" >&2
    exit 0
fi

if ! [[ -w "${OUTPUT_DIR}" ]] && ! [[ -f "${OUTPUT_FILE}" ]]; then
    echo "Skipping version generation: cannot write to ${OUTPUT_DIR} (likely Docker build)" >&2
    exit 0
fi

cat > "${OUTPUT_FILE}" << EOF
// Code generated by scripts/generate-version.sh. DO NOT EDIT.

package internal

func init() {
	MainVersion = "${MAIN_VERSION}"
	CollectorVersion = "${COLLECTOR_VERSION}"
	FactVersion = "${FACT_VERSION}"
	ScannerVersion = "${SCANNER_VERSION}"
	GitShortSha = "${GIT_SHORT_SHA}"
}
EOF

echo "Generated ${OUTPUT_FILE}" >&2
