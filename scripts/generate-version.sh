#!/usr/bin/env bash

# Generate version_data_generated.go with component version info.
#
# For dev builds: only sets BaseVersion and component versions. MainVersion and
# GitShortSha are derived at runtime from Go's built-in buildvcs (vcs.revision,
# vcs.modified) in pkg/version/internal/vcs.go. This avoids recompilation when
# the commit SHA changes.
#
# For release builds (BUILD_TAG set): also sets MainVersion directly so the
# release version is baked in at compile time.
#
# Reads version info from files (VERSION, COLLECTOR_VERSION, etc.) â€” no git
# commands needed. Output only changes when those files change, so builds almost
# never trigger recompilation of version packages.

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="${SCRIPT_DIR}/.."

cd "${ROOT_DIR}"

# Read base version from VERSION file
BASE_VERSION="$(cat VERSION 2>/dev/null || echo "0.0.x")"
# Trim trailing whitespace/newlines
BASE_VERSION="${BASE_VERSION%%[[:space:]]}"

# Read component versions from files
COLLECTOR_VERSION="$(cat COLLECTOR_VERSION 2>/dev/null || echo "0.0.0")"
FACT_VERSION="$(cat FACT_VERSION 2>/dev/null || echo "0.0.0")"
SCANNER_VERSION="$(cat SCANNER_VERSION 2>/dev/null || echo "0.0.0")"

# Generate the Go file
OUTPUT_FILE="${ROOT_DIR}/pkg/version/internal/version_data_generated.go"
OUTPUT_DIR="$(dirname "${OUTPUT_FILE}")"

# Check if we can write to the output location
# In Docker builds, the file may already exist and we may not have write permissions
if [[ -f "${OUTPUT_FILE}" ]] && ! [[ -w "${OUTPUT_FILE}" ]]; then
    echo "Skipping version generation: ${OUTPUT_FILE} exists and is not writable (likely Docker build)" >&2
    exit 0
fi

if ! [[ -w "${OUTPUT_DIR}" ]] && ! [[ -f "${OUTPUT_FILE}" ]]; then
    echo "Skipping version generation: cannot write to ${OUTPUT_DIR} (likely Docker build)" >&2
    exit 0
fi

# Generate content to a temp file first
TEMP_FILE=$(mktemp)

if [[ -n "${BUILD_TAG}" ]]; then
    # Release build: bake MainVersion directly
    cat > "${TEMP_FILE}" << EOF
// Code generated by scripts/generate-version.sh. DO NOT EDIT.

package internal

func init() {
	MainVersion = "${BUILD_TAG}"
	CollectorVersion = "${COLLECTOR_VERSION}"
	FactVersion = "${FACT_VERSION}"
	ScannerVersion = "${SCANNER_VERSION}"
	DeriveVersionFromBuildVCS()
}
EOF
else
    # Dev build: only set BaseVersion and component versions.
    # MainVersion and GitShortSha are derived at runtime from buildvcs
    # via DeriveVersionFromBuildVCS() in vcs.go.
    cat > "${TEMP_FILE}" << EOF
// Code generated by scripts/generate-version.sh. DO NOT EDIT.

package internal

func init() {
	BaseVersion = "${BASE_VERSION}"
	CollectorVersion = "${COLLECTOR_VERSION}"
	FactVersion = "${FACT_VERSION}"
	ScannerVersion = "${SCANNER_VERSION}"
	DeriveVersionFromBuildVCS()
}
EOF
fi

# Only update if content changed (preserves mtime for Go cache efficiency)
if [[ -f "${OUTPUT_FILE}" ]] && cmp -s "${TEMP_FILE}" "${OUTPUT_FILE}"; then
    rm "${TEMP_FILE}"
else
    mv "${TEMP_FILE}" "${OUTPUT_FILE}"
    echo "Generated ${OUTPUT_FILE}" >&2
fi
