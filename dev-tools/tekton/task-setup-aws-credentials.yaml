apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: setup-aws-credentials
  namespace: stackrox-builds
spec:
  description: Setup AWS credentials for MinIO/S3 cache access
  workspaces:
  - name: shared-data
    description: Workspace to store AWS credentials

  steps:
  - name: setup-credentials
    image: busybox:1.35
    script: |
      #!/bin/sh
      set -e

      # Create AWS config directory
      mkdir -p "$(workspaces.shared-data.path)/.aws"

      # Create AWS credentials file for MinIO
      cat > "$(workspaces.shared-data.path)/.aws/credentials" << EOF
      [default]
      aws_access_key_id = minioadmin
      aws_secret_access_key = minioadmin
      EOF

      # Create AWS config file
      cat > "$(workspaces.shared-data.path)/.aws/config" << EOF
      [default]
      region = us-east-1
      output = json
      EOF

      echo "AWS credentials configured for MinIO access"
      echo "Credentials file created at: $(workspaces.shared-data.path)/.aws/credentials"
      echo "Config file created at: $(workspaces.shared-data.path)/.aws/config"