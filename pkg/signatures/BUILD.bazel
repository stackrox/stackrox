load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "signatures",
    srcs = [
        "cosign_sig_fetcher.go",
        "cosign_sig_verifier.go",
        "factory.go",
        "types.go",
    ],
    embedsrcs = ["release-key-3.pub.txt"],
    importpath = "github.com/stackrox/rox/pkg/signatures",
    visibility = ["//visibility:public"],
    deps = [
        "//generated/storage",
        "//pkg/env",
        "//pkg/errox",
        "//pkg/images/utils",
        "//pkg/logging",
        "//pkg/protoconv",
        "//pkg/protoutils",
        "//pkg/registries/types",
        "//pkg/retry",
        "//pkg/set",
        "//pkg/sync",
        "//pkg/urlfmt",
        "//pkg/utils",
        "@com_github_google_go_containerregistry//pkg/name",
        "@com_github_google_go_containerregistry//pkg/v1:pkg",
        "@com_github_google_go_containerregistry//pkg/v1/remote",
        "@com_github_google_go_containerregistry//pkg/v1/remote/transport",
        "@com_github_hashicorp_go_multierror//:go-multierror",
        "@com_github_heroku_docker_registry_client//registry",
        "@com_github_pkg_errors//:errors",
        "@com_github_sigstore_cosign_v2//cmd/cosign/cli/fulcio",
        "@com_github_sigstore_cosign_v2//pkg/cosign",
        "@com_github_sigstore_cosign_v2//pkg/cosign/bundle",
        "@com_github_sigstore_cosign_v2//pkg/oci",
        "@com_github_sigstore_cosign_v2//pkg/oci/remote",
        "@com_github_sigstore_cosign_v2//pkg/oci/static",
        "@com_github_sigstore_rekor//pkg/client",
        "@com_github_sigstore_sigstore//pkg/cryptoutils",
        "@com_github_sigstore_sigstore//pkg/signature",
        "@com_github_sigstore_sigstore//pkg/signature/payload",
        "@com_github_sigstore_sigstore//pkg/tuf",
        "@org_golang_x_time//rate",
    ],
)

alias(
    name = "go_default_library",
    actual = ":signatures",
    visibility = ["//visibility:public"],
)

go_test(
    name = "signatures_test",
    srcs = [
        "cosign_sig_fetcher_test.go",
        "cosign_sig_verifier_test.go",
        "factory_test.go",
        "types_test.go",
    ],
    data = glob(["testdata/**"]),
    embed = [":signatures"],
    deps = [
        "//generated/storage",
        "//pkg/errox",
        "//pkg/images/types",
        "//pkg/images/utils",
        "//pkg/protoassert",
        "//pkg/registries/types",
        "//pkg/retry",
        "@com_github_google_go_containerregistry//pkg/crane",
        "@com_github_google_go_containerregistry//pkg/name",
        "@com_github_google_go_containerregistry//pkg/registry",
        "@com_github_google_go_containerregistry//pkg/v1/random",
        "@com_github_google_go_containerregistry//pkg/v1/remote/transport",
        "@com_github_heroku_docker_registry_client//registry",
        "@com_github_pkg_errors//:errors",
        "@com_github_sigstore_cosign_v2//pkg/cosign/bundle",
        "@com_github_sigstore_cosign_v2//pkg/oci/mutate",
        "@com_github_sigstore_cosign_v2//pkg/oci/remote",
        "@com_github_sigstore_cosign_v2//pkg/oci/static",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//require",
    ],
)
