package testutils

import (
	"errors"
	"path"
	"path/filepath"
	"runtime"
	"testing"

	"github.com/stackrox/rox/pkg/mtls"
)

// LoadTestMTLSCerts loads test TLS certificates into the according environment variables
func LoadTestMTLSCerts(t *testing.T) error {
	_, filename, _, ok := runtime.Caller(0)
	if !ok {
		return errors.New("Could not read stack trace.")
	}
	dir := filepath.Dir(filename)

	// Certs generated by testdata/generate-certs.sh
	centralCertsDir := filepath.Join(dir, "testdata", "central-certs")
	t.Setenv(mtls.CAFileEnvName, path.Join(centralCertsDir, "ca.pem"))
	t.Setenv(mtls.CAKeyFileEnvName, path.Join(centralCertsDir, "ca-key.pem"))
	t.Setenv(mtls.CertFilePathEnvName, path.Join(centralCertsDir, "leaf-cert.pem"))
	t.Setenv(mtls.KeyFileEnvName, path.Join(centralCertsDir, "leaf-key.pem"))
	return nil
}
