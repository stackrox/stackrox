name: Cache Go Dependencies
description: Cache Go Dependencies
runs:
  using: composite
  steps:
    - name: Determine Go cache paths
      id: cache-paths
      run: |
        echo "GOCACHE=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"
        echo "GOMODCACHE=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"
        echo "GOARCH=$(go env GOARCH)" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Restore Go Dependencies
      uses: actions/cache/restore@v4
      with:
        path: |
          ${{ steps.cache-paths.outputs.GOMODCACHE }}
        key: go-mod-v1-${{ hashFiles('**/go.sum') }}
        restore-keys: go-mod-v1-

    - name: Cache Go Build
      uses: actions/cache@v5
      with:
        path: |
          ${{ steps.cache-paths.outputs.GOCACHE }}
        key: go-build-v1-${{ github.job }}-${{ steps.cache-paths.outputs.GOARCH }}-${{ hashFiles('**/go.sum') }}

    - name: Cache diagnostics
      run: |
        echo "::group::Cache key info"
        echo "github.job:    ${{ github.job }}"
        echo "github.ref:    ${{ github.ref }}"
        echo "event:         ${{ github.event_name }}"
        echo "GOARCH:        ${{ steps.cache-paths.outputs.GOARCH }}"
        echo "go-mod key:    go-mod-v1-${{ hashFiles('**/go.sum') }}"
        echo "go-build key:  go-build-v1-${{ github.job }}-${{ steps.cache-paths.outputs.GOARCH }}-${{ hashFiles('**/go.sum') }}"
        echo "::endgroup::"
        echo "::group::Cache sizes after restore"
        gocache="${{ steps.cache-paths.outputs.GOCACHE }}"
        gomodcache="${{ steps.cache-paths.outputs.GOMODCACHE }}"
        echo "GOCACHE ($gocache):"
        du -sh "$gocache" 2>/dev/null || echo "  (empty or missing)"
        echo "GOMODCACHE ($gomodcache):"
        du -sh "$gomodcache" 2>/dev/null || echo "  (empty or missing)"
        echo "::endgroup::"
      shell: bash

    - name: Download Go modules
      run: make deps --always-make
      shell: bash
