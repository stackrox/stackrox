name: Cache Go Dependencies
description: Cache Go Dependencies
runs:
  using: composite
  steps:
    - name: Determine Go cache paths
      id: cache-vars
      run: |
        echo "GOCACHE=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"
        echo "GOMODCACHE=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"
        echo "GOARCH=$(go env GOARCH)" >> "$GITHUB_OUTPUT"
        # match actions/setup-go automatic caching: example "setup-go-Linux-x64-ubuntu24-go-1.24.4-77e80c4c2cea3e3fe3c8188302d5f5cb3d0de367fe8d8c5e6dcb5ec4da1b547b"
        platform=${RUNNER_OS:-Linux}
        arch=${RUNNER_ARCH:-X64}
        arch=${arch,,}  # js process.arch is lowercase
        linuxVersion="${ImageOS:-ubuntu24}"
        versionSpec="$(go env GOVERSION)"
        versionSpec=${versionSpec#go}
        echo "key=${platform}-${arch}-${linuxVersion}-go-${versionSpec}" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Cache Go Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ${{ steps.cache-vars.outputs.GOCACHE }}
          ${{ steps.cache-vars.outputs.GOMODCACHE }}
        key: setup-go-${{ steps.cache-vars.outputs.key }}-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          # match actions/setup-go automatic caching: setup-go-Linux-x64-ubuntu24-go-1.24.4-77e80c4c2cea3e3fe3c8188302d5f5cb3d0de367fe8d8c5e6dcb5ec4da1b547b
          setup-go-Linux-x64-

    - name: Download Go modules
      run: |
        make deps --always-make
      shell: bash
