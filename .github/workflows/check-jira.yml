name: "RELEASE: Check jira issues"
on:
  push:
  #milestone:
  #  types:
  #    - created

  workflow_dispatch:
    inputs:
      version:
        description: Full version A.B.C
        required: true
        default: 1.0.0
        type: string
      dry-run:
        description: Dry-run
        required: false
        default: true
        type: boolean

env:
  main_branch: ${{github.event.repository.default_branch}}
  script_url: /repos/${{github.repository}}/contents/.github/workflows/scripts/common.sh?ref=${{ github.ref_name }}
  DRY_RUN: ${{ fromJSON('["true", "false"]')[github.event.inputs.dry-run != 'true'] }}
  ACCEPT_RAW: "Accept: application/vnd.github.v3.raw"
  GH_TOKEN: ${{ github.token }}
  GH_NO_UPDATE_NOTIFIER: 1
  TIMEOUT_WAIT_FOR_IMAGES_SECONDS: 3600

jobs:
  properties:
    runs-on: ubuntu-latest
    outputs:
      slack-channel: ${{ fromJSON(format('["{0}","{1}"]', steps.fetch.outputs.dry-slack-channel, steps.fetch.outputs.slack-channel))[github.event.inputs.dry-run != 'true'] }}
      jira-projects: ${{ steps.fetch.outputs.jira-projects }}
    steps:
      - name: Read workflow properties file
        id: fetch
        env:
          PROPERTIES_URL: /repos/${{ github.repository }}/contents/.github/properties?ref=${{ github.ref_name }}
        run: gh api -H "$ACCEPT_RAW" "$PROPERTIES_URL" >> "$GITHUB_OUTPUT"

  log-run-parameters:
    name: Run parameters
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Event: ${{github.event_name}}" >>"$GITHUB_STEP_SUMMARY"
          if [ "${{github.event_name}}" = "workflow_dispatch" ]; then
            cat <<EOF >>"$GITHUB_STEP_SUMMARY"
          \`\`\`
          ${{toJSON(inputs)}}
          \`\`\`
          EOF
          fi

  check-jira:
    name: Check Jira tickets for release
    needs: [properties]
    runs-on: ubuntu-latest
    steps:
      - name: Query JIRA
        env:
          JIRA_TOKEN: ${{ secrets.JIRA_TOKEN }}
        run: |
          set -x
          set -uo pipefail
          release="${{github.event.inputs.version}}"
          patch="${release%%*.}"
          named_release_patch="${release}"
          pwd
          ls -la
          gh api -H "$ACCEPT_RAW" "${{env.script_url}}" | bash -s -- \
            check-jira-issues \
            "${{needs.properties.outputs.jira-projects}}" \
            "${release:-4.6.0}" \
            "${patch:-0}" \
            "${named_release_patch:-4.6.0}"
