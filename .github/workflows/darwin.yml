name: Darwin compatibility check
on:
  push:
    branches:
    - master
  pull_request:
    types:
    - opened
    - reopened
    - synchronize

jobs:
  build-go-binaries:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - uses: cachix/install-nix-action@v23
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          accept-flake-config = true
          trusted-substituters = https://stackrox.cachix.org https://cache.nixos.org/
          trusted-public-keys = stackrox.cachix.org-1:Wnn8TKAitOTWKfTvvHiHzJjXy0YfiwoK6rrVzXt/trA= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Run tests
      env:
        CGO_ENABLED: "1"
        GOOS: "darwin"
        GOARCH: "amd64"
      shell: nix develop ./nix --quiet --command bash -e {0}
      run: make main-build-nodeps
