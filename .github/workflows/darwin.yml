name: Darwin compatibility check
on:
  push:
    branches:
    - master
  pull_request:
    types:
    - opened
    - reopened
    - synchronize

jobs:
  build-go-binaries:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Cache Go dependencies
      uses: ./.github/actions/cache-go-dependencies

    - uses: cachix/install-nix-action@v22
      with:
        extra_nix_config: |
          accept-flake-config = true
          trusted-substituters = https://stackrox.cachix.org https://cache.nixos.org/
          trusted-public-keys = stackrox.cachix.org-1:Wnn8TKAitOTWKfTvvHiHzJjXy0YfiwoK6rrVzXt/trA= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

    - name: Checkout stackrox-env flake
      uses: actions/checkout@v4
      with:
        repository: stackrox/stackrox-env
        path: dev/nix
        ref: 77a2d872be4e38046abe86308ec0c36f8a508e78

    - name: Run tests
      env:
        CGO_ENABLED: "1"
        GOOS: "darwin"
        GOARCH: "amd64"
      shell: nix develop ./dev/nix --quiet --command bash -e {0}
      run: make go-unit-tests

    - name: Generate junit report
      if: always()
      run: make generate-junit-reports

    - name: Publish Test Report
      uses: test-summary/action@v2
      if: always()
      with:
        paths: 'junit-reports/report.xml'
