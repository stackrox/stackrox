name: Parse Version
on:
  workflow_call:
    inputs:
      version:
        description: Version (A.B.C or A.B.C-rc.D)
        type: string
        required: true

    outputs:
      release:
        description: Release number (A.B)
        value: ${{jobs.parse.outputs.release}}
      patch:
        description: Patch number (C)
        value: ${{jobs.parse.outputs.patch}}
      rc:
        description: RC number (D)
        value: ${{jobs.parse.outputs.rc}}
      release-patch:
        description: Release.patch numbers (A.B.C)
        value: ${{format('{0}.{1}', jobs.parse.outputs.release, jobs.parse.outputs.patch)}}
      branch:
        description: Release branch name (release/A.B.x)
        value: ${{format('release/{0}.x', jobs.parse.outputs.release)}}
      docs-branch:
        description: Documentation branch name
        value: ${{format('rhacs-docs-{0}.{1}', jobs.parse.outputs.release, jobs.parse.outputs.patch)}}
      milestone:
        description: Milestone (A.B.C-rc.D)
        value: ${{jobs.parse.outputs.milestone}}
      next-milestone:
        description: Next milestone (A.B.C-rc.`D+1`)
        value: ${{jobs.parse.outputs.next-milestone}}

jobs:
  parse:
    name: Parse ${{inputs.version}}
    runs-on: ubuntu-latest
    outputs:
      release: ${{steps.parse.outputs.release}}
      patch: ${{steps.parse.outputs.patch}}
      rc: ${{steps.parse.outputs.rc}}
      milestone: ${{steps.parse.outputs.milestone}}
      next-milestone: ${{steps.parse.outputs.next-milestone}}
    steps:
      - id: parse
        run: |
          read RELEASE PATCH_NUMBER RC_NUMBER <<< \
          $(sed -rn 's/^([0-9]+\.[0-9]+)\.([0-9]+)(-rc\.([0-9]+))?$/\1 \2 \4/p' <<< ${{inputs.version}})
          if [ -z "$RELEASE" -o -z "$PATCH_NUMBER"]; then
            echo "::error::Cannot parse ${{inputs.version}}: should be in a form of `X.X.X-rc.X`, where `X` is a decimal number."
            exit 1
          fi
          if [ -z "$RC_NUMBER" ]; then RC_NUMBER=1; fi
          NEXT_RC_NUMBER=$((RC_NUMBER+1))
          echo "::set-output name=release::$RELEASE"
          echo "::set-output name=patch::$PATCH_NUMBER"
          echo "::set-output name=rc::$RC_NUMBER"
          echo "::set-output name=milestone::$RELEASE.$PATCH_NUMBER-rc.$RC_NUMBER"
          echo "::set-output name=next-milestone::$RELEASE.$PATCH_NUMBER-rc.$NEXT_RC_NUMBER"
