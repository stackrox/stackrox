name: E2E tests
on:
  pull_request:
env:
  ROX_PRODUCT_BRANDING: stackrox

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    container:
      image: quay.io/stackrox-io/apollo-ci:stackrox-test-0.4.9
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/job-preamble
        with:
          gcp-account: ${{ secrets.GCP_SERVICE_ACCOUNT_STACKROX_CI }}

      - continue-on-error: true
        run: |
          source scripts/ci/lib.sh
          test_on_infra
          echo "SHARED_DIR=${SHARED_DIR}" | tee -a "$GITHUB_ENV"
          echo "REMOVE_EXISTING_STACKROX_RESOURCES=false" | tee -a "$GITHUB_ENV"
          export JOB_NAME="${JOB_NAME:-ocp-4-19-qa-e2e-tests}" | tee -a "$GITHUB_ENV"
          echo "JOB_NAME=${JOB_NAME}" | tee -a "$GITHUB_ENV"
          echo "JOB_NAME_SAFE=qa-e2e-tests" | tee -a "$GITHUB_ENV"
          echo "CI=true" | tee -a "$GITHUB_ENV"
          echo "GRADLE_USER_HOME=${HOME}" | tee -a "$GITHUB_ENV"
          echo "CI_JOB_NAME=${JOB_NAME}" | tee -a "$GITHUB_ENV"
          ARTIFACT_DIR="${ARTIFACT_DIR:-${SHARED_DIR}/tmp/}}"
          mkdir -p "$ARTIFACT_DIR"
          echo "ARTIFACT_DIR=${ARTIFACT_DIR}" | tee -a "$GITHUB_ENV"

      - run: |
          export PYTHONPATH="${PYTHONPATH:-}:.openshift-ci"
          # scripts/ci/jobs/ocp_qa_e2e_tests.py
          bash -x .openshift-ci/dispatch.sh "$JOB_NAME"
