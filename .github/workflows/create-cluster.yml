name: Create Test Cluster
on:
  workflow_call:
    inputs:
      flavor:
        description: Flavor
        type: string
        required: true
      name:
        description: Cluster name
        type: string
        required: true
      lifespan:
        description: Cluster lifespan
        type: string
        default: 48h
        required: false
      args:
        description: Comma separated flavor arguments. Ex. nodes=5,main-image=main:tag
        type: string
        required: false
        # Spaces in arguments are not supported.
        default: ""
      wait:
        description: Wait or not for the cluster readiness
        type: boolean
        required: false
        default: false
jobs:
  infra:
    runs-on: ubuntu-latest
    steps:
      - name: Download infractl
        run: |
          curl -sL https://infra.rox.systems/v1/cli/linux/amd64/upgrade \
          | jq -r ".result.fileChunk" \
          | base64 -d \
          > infractl
          chmod +x infractl
      - name: Create Cluster
        env:
          INFRA_TOKEN: ${{secrets.INFRA_TOKEN}}
        run: |
          NAME="${{inputs.name}}"

          OPTIONS=()
          if [ "${{inputs.wait}}" = "true" ]; then
            OPTIONS+=("--wait")
            echo "::warning::The job will wait for the cluster creation."
          fi

          IFS=', ' read -ra args <<< "${{inputs.args}}"
          for arg in ${args[@]}; do
            OPTIONS+=("--arg")
            OPTIONS+=("$arg")
          done

          ./infractl create "${{inputs.flavor}}" "${NAME//./-}" \
            --lifespan "${{inputs.lifespan}}" \
            "${OPTIONS[@]}"

          ./infractl get "${NAME//./-}" >> $GITHUB_STEP_SUMMARY
