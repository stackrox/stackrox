name: "Check PR title"

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-title:
    runs-on: ubuntu-latest
    steps:
      - name: Check if the PR title is well dressed
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          CONV: '(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([\w\-\.]+\))?!?'
          JIRA: '([A-Z]+-[0-9]+, ?)*[A-Z]+-[0-9]+'
          TEXT: ': .+'
          LENGTH: '70'
        run: |
          # Either conventional or ROX-nnn prefix followed by ': ' and random text:
          REGEX="(($CONV)|($JIRA))($TEXT)"
          test_regex() { echo -nE "$1" | grep --perl-regexp --line-regexp "$REGEX" ; }

          echo "Examples:"
          test_regex 'ROX-123: text'
          test_regex 'ROX-123, RS-45: text'
          test_regex 'refactor: text'
          test_regex 'fix(ui): text'
          test_regex 'feat(api)!: text'

          if ! test_regex "$PR_TITLE"
          then
            echo "::error::Please update the PR title so that it follows the convention."
            exit 1
          fi

          if [ "$(echo -nE "$PR_TITLE" | wc --chars)" -gt "$LENGTH" ]
          then
            echo "::error::Please shorten the PR title to be $LENGTH characters or less."
            exit 1
          fi
