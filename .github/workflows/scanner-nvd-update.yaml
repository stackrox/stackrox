name: Scanner NVD update

on:
  push:
    branches:
    - 'yli3/**'
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  fetch-cves:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GOOGLE_SA_STACKROX_HUB_VULN_DUMP_UPLOADER }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Fetch CVEs
      env:
        SCANNER_NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        SCANNER_NVD_URL: https://services.nvd.nist.gov/rest/json/cves/2.0
      run: |
        set -eu
        dir=$(mktemp -d)
        python3 .github/workflows/scripts/scanner-update-nvd.py "$dir"
        mkdir nvd-bundle
        tar -czf nvd-bundle/nvd-data.tar.gz -C "$dir" .
        gsutil cp -r nvd-bundle "gs://definitions.stackrox.io/v4"

  send-notification:
    needs:
    - fetch-cves
    runs-on: ubuntu-latest
    if: failure()
    steps:
    - name: Send Slack notification on workflow failure
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{"text":"<${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}|Workflow ${{ github.workflow }}> failed in repository ${{ github.repository }}: Failed to update NVD CVEs"}' ${{ secrets.SLACK_ONCALL_SCANNER_WEBHOOK }}
