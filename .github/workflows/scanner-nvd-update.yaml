name: Scanner NVD Update

on:
  push:
    branches:
    - 'yli3/**'
  schedule:
  - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  fetch-cves:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GOOGLE_SA_STACKROX_HUB_VULN_DUMP_UPLOADER }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Fetch CVEs
      env:
        SCANNER_NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        SCANNER_NVD_URL: https://nvd.nist.gov/feeds/json/cve/1.1
      run: |
        set -eu
        dir=$(mktemp -d)
        python3 .github/workflows/scripts/scanner-fetch-nvd-feeds.py "$dir"
        
        # Remove the original yearly JSON data files
        find "$dir" -name 'nvdcve-1.1-*.json' -type f -delete
        
        ls -lh "$dir"
        mkdir nvd-v1-bundle
        zip -r nvd-v1-bundle/feeds.zip "$dir"
        ls -lh nvd-v1-bundle/feeds.zip
