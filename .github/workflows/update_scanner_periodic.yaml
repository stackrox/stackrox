name: Update scanner version
on:
  workflow_dispatch:
  schedule:
  - cron: 0 5 * * 1
jobs:
  determine-new-scanner-version:
    runs-on: ubuntu-latest
    outputs:
      new-scanner-version: ${{ steps.update-version.outputs.new-scanner-version }}
    steps:
    - name: Checkout scanner repo
      uses: actions/checkout@v4
      with:
        repository: stackrox/scanner
        fetch-depth: 0 # we need to fetch tags
    - name: Update version
      id: update-version
      run: |
        echo "new-scanner-version=$(make -s tag)" >> "${GITHUB_OUTPUT}"

  ensure-images-exist:
    runs-on: ubuntu-latest
    needs: determine-new-scanner-version
    strategy:
      matrix:
        image: ["scanner", "scanner-slim", "scanner-db", "scanner-db-slim"]
        tag_suffix: ["", "-fast"]
    steps:
    - name: Ensure image exists
      uses: stackrox/actions/release/wait-for-image@v1
      with:
        token: ${{ secrets.QUAY_RHACS_ENG_BEARER_TOKEN }}
        image: rhacs-eng/${{ matrix.image }}:${{ needs.determine-new-scanner-version.outputs.new-scanner-version }}${{ matrix.tag_suffix }}
        limit: 1800

  create-pr:
    runs-on: ubuntu-latest
    needs: [determine-new-scanner-version, ensure-images-exist]
    steps:
    - uses: actions/checkout@v4
      with:
        ref: master # this is our target branch
        fetch-depth: 0 # we need to fetch all branches
    - name: Update SCANNER_VERSION
      run: |
        echo "${{ needs.determine-new-scanner-version.outputs.new-scanner-version }}" > SCANNER_VERSION
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v7
      with:
        token: '${{ secrets.RHACS_BOT_GITHUB_TOKEN }}'
        commit-message: Update SCANNER_VERSION
        committer: '${{ secrets.RHACS_BOT_GITHUB_USERNAME }} <${{ secrets.RHACS_BOT_GITHUB_EMAIL }}>'
        author: '${{ secrets.RHACS_BOT_GITHUB_USERNAME }} <${{ secrets.RHACS_BOT_GITHUB_EMAIL }}>'
        branch: update_scanner_version
        signoff: false
        delete-branch: true
        title: 'chore(scanner): Update SCANNER_VERSION'
        body: |
          Weekly update of SCANNER_VERSION to latest master version
        labels: |
          ci-all-qa-tests
          dependencies
        team-reviewers: scanner
        draft: false
    - name: Enable Pull Request Automerge
      if: steps.cpr.outputs.pull-request-operation == 'created'
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: '${{ secrets.RHACS_BOT_GITHUB_TOKEN }}'
        pull-request-number: '${{ steps.cpr.outputs.pull-request-number }}'
        merge-method: squash
