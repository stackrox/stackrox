name: Build
on:
  pull_request:
    types:
    - opened
    - synchronize

env:
  ORG_TOKEN_FOR_GITHUB: ${{ secrets.ORG_TOKEN_FOR_GITHUB }}
  QUAY_RHACS_ENG_RO_USERNAME: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
  QUAY_RHACS_ENG_RO_PASSWORD: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}

jobs:

  pre-create-tag:
    runs-on: ubuntu-latest
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-test-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble
        with:
          get_CI_TAG: "false"

      - name: Create a consistent tag for CI workflow
        run: |
            make --quiet tag | tee CI_TAG_TMP
            mv CI_TAG_TMP CI_TAG
            # check for a valid tag - when 'make --quiet tag' fails it can output a newline and exit with 0
            (( $(stat -c%s CI_TAG) > 1 )) || { echo "An invalid tag was created:"; cat CI_TAG; exit 1; }

      - uses: actions/upload-artifact@v3
        with: 
          name: CI_TAG
          path: CI_TAG

  pre-build-ui:
    runs-on: ubuntu-latest
    needs: pre-create-tag
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-test-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble

      - uses: ./.github/actions/create-concatenated-ui-monorepo-lock

      - uses: ./.github/actions/cache-ui-dependencies

      - name: Fetch UI deps
        run: make -C ui deps

      - name: Build UI
        run: make -C ui build

      - uses: actions/upload-artifact@v3
        with: 
          name: ui-build
          path: |
            ui/build
            ui/monorepo.lock

  pre-build-cli:
    runs-on: ubuntu-latest
    needs: pre-create-tag
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-build-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble

      - name: Build CLI
        run: make cli

      - name: Bundle build to preserve permissions
        run: tar -cvzf cli-build.tgz bin

      - uses: actions/upload-artifact@v3
        with: 
          name: cli-build
          path: cli-build.tgz

  pre-build-go-binaries:
    runs-on: ubuntu-latest
    needs: pre-create-tag
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-build-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble

      - name: Build Go Binaries
        run: make build-prep main-build-nodeps

      - name: Bundle the build to preserve permissions
        run: tar -cvzf go-binaries-build.tgz bin/linux

      - uses: actions/upload-artifact@v3
        with: 
          name: go-binaries-build
          path: go-binaries-build.tgz

  pre-build-docs:
    runs-on: ubuntu-latest
    needs: pre-create-tag
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-test-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble

      - name: Generate the swagger docs
        run: |
          make swagger-docs
          # Workarround to handle https://github.com/actions/cache/issues/753
          rm -rf .proto

      - uses: actions/upload-artifact@v3
        with:
          name: docs-build
          path: |
            image/docs

  build:
    runs-on: ubuntu-latest
    needs: 
      - pre-build-ui
      - pre-build-cli
      - pre-build-go-binaries
      - pre-build-docs
    container:
      image: quay.io/rhacs-eng/apollo-ci:stackrox-test-0.3.32-9-g5151fd607d
      credentials:
        username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
        password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}
      env:
        DOCKER_IO_PUSH_USERNAME: ${{ secrets.DOCKER_IO_PUSH_USERNAME }}
        DOCKER_IO_PUSH_PASSWORD: ${{ secrets.DOCKER_IO_PUSH_PASSWORD }}
        QUAY_RHACS_ENG_RW_USERNAME: ${{ secrets.QUAY_RHACS_ENG_RW_USERNAME }}
        QUAY_RHACS_ENG_RW_PASSWORD: ${{ secrets.QUAY_RHACS_ENG_RW_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Job Preamble
        uses: ./.github/actions/job-preamble

      - name: Checkout submodules
        run: |
            git submodule update --init

      - uses: actions/download-artifact@v3
        with:
          name: CI_TAG

      - uses: actions/download-artifact@v3
        with:
          name: ui-build
          path: ui

      - uses: actions/download-artifact@v3
        with:
          name: cli-build

      - name: Unpack cli build
        run: |
          tar xvzf cli-build.tgz

      - uses: actions/download-artifact@v3
        with:
          name: go-binaries-build

      - name: Unpack Go binaries build
        run: |
          tar xvzf go-binaries-build.tgz

      - uses: actions/download-artifact@v3
        with:
          name: docs-build
          path: image/docs

      - uses: ./.github/actions/cache-ui-dependencies

      - name: Docker login
      # (needed for docs pull)
        run: |
            docker login -u "${{ env.QUAY_RHACS_ENG_RO_USERNAME }}" --password-stdin quay.io <<<"${{ env.QUAY_RHACS_ENG_RO_PASSWORD }}"

      - name: Generate OSS notice
        run: make ossls-notice

      - name: Build main image
        run: make docker-build-main-image

      - name: Check debugger presence in the main image
        run: make check-debugger

      - name: Build roxctl image
        run: make docker-build-roxctl-image

      - name: Push main and roxctl images
        run: |
            source ./scripts/ci/lib.sh
            push_main_and_roxctl_images "${GITHUB_HEAD_REF}"

      - name: Push matching collector and scanner images
        run: |
            source ./scripts/ci/lib.sh
            push_matching_collector_scanner_images

  hand-off-to-circle-ci:
    runs-on: ubuntu-latest
    needs:
      - build
    env:
      CIRCLECI_TOKEN: ${{ secrets.CIRCLE_TOKEN_ROXBOT }}
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: CI_TAG

      - name: Trigger Circle CI
        run: |
          curl -X POST \
              --header 'Content-Type: application/json' \
              --header "Circle-Token: ${{ env.CIRCLECI_TOKEN }}" \
              https://circleci.com/api/v2/project/github/stackrox/stackrox/pipeline \
              -d @- << __EOD__
          {
            "branch": "${GITHUB_HEAD_REF}",
            "parameters": {
              "trigger_on_demand": true,
              "workflow_name": "e2e-tests",
              "tag": "$(cat CI_TAG)"
            }
          }
          __EOD__
