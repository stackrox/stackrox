name: "RELEASE: Scan images for vulnerabilities"
on:
  workflow_dispatch:
    inputs:
      version:
        description: Full version tag
        required: true
        default: 0.0.0-test-rc.1
        type: string
      wait-for-images-limit:
        description: Duration to wait for images to be available (as Go duration string, set 0 to skip waiting)
        required: true
        # When changing the default here, also update the default in run-parameters.
        default: 3h10m
        type: string
  push:
    tags: ['*']

run-name: ${{ format('Scan images for vulnerabilities ({0})', inputs.version || github.ref_name) }}

jobs:
  run-parameters:
    name: Run parameters
    runs-on: ubuntu-latest
    outputs:
      wait-for-images-limit: ${{ steps.run-parameters.outputs.wait-for-images-limit }}
      version: ${{ steps.run-parameters.outputs.version }}
    steps:
      - name: Run parameters
        id: run-parameters
        run: |
          wait_for_images_limit="${{ inputs.wait-for-images-limit || '3h10m' }}"
          version="${{ inputs.version || github.ref_name }}"
          echo "wait-for-images-limit=${wait_for_images_limit}" >> "${GITHUB_OUTPUT}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          {
            echo "Event: ${{ github.event_name }}"
            echo "Version: ${version}"
            echo "Wait for images limit: ${wait_for_images_limit}"
            echo "Inputs:"
            echo '```'
            echo "${{ toJSON(inputs) }}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

  parse-wait-for-images-limit:
    name: Parse wait-for-images-limit
    runs-on: ubuntu-latest
    needs: [run-parameters]
    outputs:
      wait-limit: ${{ steps.parse-wait-limit.outputs.wait-limit }}
    steps:
      - name: Parse wait-for-images-limit
        id: parse-wait-limit
        run: |
          wait_limit="$(sed 's/d/*24*3600 +/g; s/h/*3600 +/g; s/m/*60 +/g; s/s/\+/g; s/+[ ]*$//g' <<< "${{ needs.run-parameters.outputs.wait-for-images-limit }}" | bc)"
          echo "wait-limit=${wait_limit}" >> "${GITHUB_OUTPUT}"

  scan-image-vulnerabilities-upstream:
    name: "Upstream: ${{ matrix.image }}:${{ needs.run-parameters.outputs.version }}"
    runs-on: ubuntu-latest
    needs: [run-parameters, parse-wait-for-images-limit]
    permissions:
      # Needed for stackrox/central-login to create the JWT token.
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          [
            "central-db",
            "collector",
            "main",
            "roxctl",
            "scanner",
            "scanner-db",
            "scanner-db-slim",
            "scanner-slim",
            "scanner-v4",
            "scanner-v4-db",
            "stackrox-operator",
          ]
    steps:
      - name: Sanitize nightly version
        id: sanitize-nightly-version
        run: |
          set -euo pipefail
          tag="${{ needs.run-parameters.outputs.version }}"
          if [[ "${{ matrix.image }}" = "stackrox-operator" && "${tag}" == *-nightly-* ]]; then
            # Extract version part before -nightly- and replace patch version with 0
            # Example: 0.1.x-nightly-20260114 -> 0.1.0-nightly-20260114
            version_part="${tag%%-nightly-*}"
            rest_part="${tag#*-nightly-}"
            version_part=$(echo "$version_part" | sed -E 's/([0-9]+\.[0-9]+\.)x/\10/')
            tag="${version_part}-nightly-${rest_part}"
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
      - name: Scan image vulnerabilities
        uses: stackrox/actions/release/scan-image-vulnerabilities@v1
        id: scan-image
        with:
          image: rhacs-eng/${{ matrix.image }}
          version: ${{ steps.sanitize-nightly-version.outputs.tag }}
          wait-limit: ${{ needs.parse-wait-for-images-limit.outputs.wait-limit }}
          summary-prefix: "Upstream:"
          quay-bearer-token: ${{ secrets.QUAY_RHACS_ENG_BEARER_TOKEN }}
          central-url: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}

      - name: Upload scan result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upstream_quay_io_rhacs-eng_${{ matrix.image }}_${{ needs.run-parameters.outputs.version }}.json
          path: ${{ steps.scan-image.outputs.result-path }}
          retention-days: 30

  scan-image-vulnerabilities-konflux:
    name: "Konflux: ${{ matrix.image }}:${{ needs.run-parameters.outputs.version }}"
    runs-on: ubuntu-latest
    needs: [run-parameters, parse-wait-for-images-limit]
    permissions:
      # Needed for stackrox/central-login to create the JWT token.
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          [
            "release-central-db",
            "release-collector",
            "release-main",
            "release-roxctl",
            "release-scanner",
            "release-scanner-db",
            "release-scanner-db-slim",
            "release-scanner-slim",
            "release-scanner-v4",
            "release-scanner-v4-db",
            "release-operator",
          ]
    steps:
      - name: Sanitize nightly version
        id: sanitize-nightly-version
        run: |
          set -euo pipefail
          tag="${{ needs.run-parameters.outputs.version }}"
          if [[ "${tag}" == *-nightly-* ]]; then
            suffix="fast"
            # Extract version part before -nightly- and replace patch version with 0
            # Example: 0.1.x-nightly-20260114 -> 0.1.0-nightly-20260114-fast
            version_part="${tag%%-nightly-*}"
            rest_part="${tag#*-nightly-}"
            version_part=$(echo "$version_part" | sed -E 's/([0-9]+\.[0-9]+\.)x/\10/')
            tag="${version_part}-nightly-${rest_part}-${suffix}"
          fi
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"

      - name: Scan image vulnerabilities
        uses: stackrox/actions/release/scan-image-vulnerabilities@v1
        id: scan-image
        with:
          image: rhacs-eng/${{ matrix.image }}
          version: ${{ steps.sanitize-nightly-version.outputs.tag }}
          wait-limit: ${{ needs.parse-wait-for-images-limit.outputs.wait-limit }}
          summary-prefix: "Konflux:"
          quay-bearer-token: ${{ secrets.QUAY_RHACS_ENG_BEARER_TOKEN }}
          central-url: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}

      - name: Upload scan result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: konflux_quay_io_rhacs-eng_${{ matrix.image }}_${{ needs.run-parameters.outputs.version }}.json
          path: ${{ steps.scan-image.outputs.result-path }}
          retention-days: 30
