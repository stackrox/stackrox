name: "RELEASE: Check image vulnerabilities"
on:
  workflow_dispatch:
    inputs:
      version:
        description: Full version tag
        required: true
        default: 0.0.0-test-rc.1
        type: string
  push:
    tags: ['*']

run-name: ${{ format('Check image vulnerabilities for {0}', inputs.version) }}

jobs:
  run-parameters:
    name: Run parameters
    runs-on: ubuntu-latest
    steps:
      - run: |
          {
            echo "Event: ${{ github.event_name }}"
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo '```'
              echo "${{ toJSON(inputs) }}"
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  check-image-vulnerabilities-upstream:
    name: "Upstream: ${{ matrix.image }}:${{ inputs.version }}"
    runs-on: ubuntu-latest
    permissions:
      # Needed for stackrox/central-login to create the JWT token.
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          [
            "central-db",
            "collector",
            "main",
            "roxctl",
            "scanner",
            "scanner-db",
            "scanner-db-slim",
            "scanner-slim",
            "scanner-v4",
            "scanner-v4-db",
            "stackrox-operator",
          ]
    steps:
      - name: Quay login
        uses: docker/login-action@v3
        with:
          registry: quay.io/rhacs-eng
          username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
          password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}

      - name: "Wait for image to be built: quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}"
        uses: stackrox/actions/release/wait-for-image@v1
        with:
          token: ${{ secrets.QUAY_RHACS_ENG_BEARER_TOKEN }}
          image: rhacs-eng/${{ matrix.image }}:${{ inputs.version }}
          limit: 7200

      - name: Central login
        uses: stackrox/central-login@v1
        with:
          endpoint: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}

      - name: Install roxctl
        uses: stackrox/roxctl-installer-action@v1
        with:
          central-endpoint: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}
          central-token: ${{ env.ROX_API_TOKEN }}

      - name: Fail if critical or important vulnerabilities have been found
        run: |
          RESULT=$(roxctl image scan --output=json --force \
            --image="quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}")
          echo "$RESULT" > scan-result.json
          CRITICAL_CNT=$(jq ".result.summary.CRITICAL" <<< "$RESULT")
          IMPORTANT_CNT=$(jq ".result.summary.IMPORTANT" <<< "$RESULT")
          if (( CRITICAL_CNT + IMPORTANT_CNT > 0 )); then
            echo "Found $CRITICAL_CNT critical vulnerabilities."
            echo "Found $IMPORTANT_CNT important vulnerabilities."
            echo "Check the workflow summary for a detailed list of the vulnerabilities."
            {
              echo "### Upstream vulnerabilities: ${{ matrix.image }}:${{ inputs.version }}"
              echo ""
              # We need a monospaced font for the table layout, and `terraform` has
              # nicer color highlighting than the default language agnostic code block.
              echo '```terraform'
              roxctl image scan --output=table --force \
                --image="quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}" \
                --severity="IMPORTANT,CRITICAL" \
                --headers="COMPONENT,VERSION,CVE,SEVERITY,FIXED_VERSION,LINK" \
                --row-jsonpath-expressions="{result.vulnerabilities.#.componentName,result.vulnerabilities.#.componentVersion,result.vulnerabilities.#.cveId,result.vulnerabilities.#.cveSeverity,result.vulnerabilities.#.componentFixedVersion,result.vulnerabilities.#.cveInfo}"
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "No important or critical vulnerabilities found."
          fi

      - name: Upload scan result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-result-${{ matrix.image }}
          path: scan-result.json
          retention-days: 30

  check-image-vulnerabilities-konflux:
    name: "Konflux: ${{ matrix.image }}:${{ inputs.version }}"
    runs-on: ubuntu-latest
    permissions:
      # Needed for stackrox/central-login to create the JWT token.
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          [
            "release-central-db",
            "release-collector",
            "release-main",
            "release-roxctl",
            "release-scanner",
            "release-scanner-db",
            "release-scanner-db-slim",
            "release-scanner-slim",
            "release-scanner-v4",
            "release-scanner-v4-db",
            "release-operator",
          ]
    steps:
      - name: Quay login
        uses: docker/login-action@v3
        with:
          registry: quay.io/rhacs-eng
          username: ${{ secrets.QUAY_RHACS_ENG_RO_USERNAME }}
          password: ${{ secrets.QUAY_RHACS_ENG_RO_PASSWORD }}

      - name: "Wait for image to be built: quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}"
        uses: stackrox/actions/release/wait-for-image@v1
        with:
          token: ${{ secrets.QUAY_RHACS_ENG_BEARER_TOKEN }}
          image: rhacs-eng/${{ matrix.image }}:${{ inputs.version }}
          limit: 11400

      - name: Central login
        uses: stackrox/central-login@v1
        with:
          endpoint: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}

      - name: Install roxctl
        uses: stackrox/roxctl-installer-action@v1
        with:
          central-endpoint: ${{ vars.ACS_DOGFOODING_CENTRAL_URL }}
          central-token: ${{ env.ROX_API_TOKEN }}

      - name: Fail if critical or important vulnerabilities have been found
        run: |
          RESULT=$(roxctl image scan --output=json --force \
            --image="quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}")
          echo "$RESULT" > scan-result.json
          CRITICAL_CNT=$(jq ".result.summary.CRITICAL" <<< "$RESULT")
          IMPORTANT_CNT=$(jq ".result.summary.IMPORTANT" <<< "$RESULT")
          if (( CRITICAL_CNT + IMPORTANT_CNT > 0 )); then
            echo "Found $CRITICAL_CNT critical vulnerabilities."
            echo "Found $IMPORTANT_CNT important vulnerabilities."
            echo "Check the workflow summary for a detailed list of the vulnerabilities."
            {
              echo "### Konflux vulnerabilities: ${{ matrix.image }}:${{ inputs.version }}"
              echo ""
              # We need a monospaced font for the table layout, and `terraform` has
              # nicer color highlighting than the default language agnostic code block.
              echo '```terraform'
              roxctl image scan --output=table --force \
                --image="quay.io/rhacs-eng/${{ matrix.image }}:${{ inputs.version }}" \
                --severity="IMPORTANT,CRITICAL" \
                --headers="COMPONENT,VERSION,CVE,SEVERITY,FIXED_VERSION,LINK" \
                --row-jsonpath-expressions="{result.vulnerabilities.#.componentName,result.vulnerabilities.#.componentVersion,result.vulnerabilities.#.cveId,result.vulnerabilities.#.cveSeverity,result.vulnerabilities.#.componentFixedVersion,result.vulnerabilities.#.cveInfo}"
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "No important or critical vulnerabilities found."
          fi

      - name: Upload scan result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-result-${{ matrix.image }}
          path: scan-result.json
          retention-days: 30
