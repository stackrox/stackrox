apiVersion: kuttl.dev/v1beta1
kind: TestAssert
collectors:
- type: pod
  selector: app=central
  tail: -1
- type: pod
  selector: app=central-db
  tail: -1
- type: pod
  selector: app=config-controller
  tail: -1
- type: pod
  selector: app=scanner
  tail: -1
- type: pod
  selector: app=scanner-db
  tail: -1
- type: pod
  selector: app=scanner-v4-indexer
  tail: -1
- type: pod
  selector: app=scanner-v4-matcher
  tail: -1
- type: pod
  selector: app=scanner-v4-db
  tail: -1
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=central
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=central-db
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=config-controller
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=scanner
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=scanner-db
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=scanner-v4-indexer
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=scanner-v4-matcher
- command: retry-kubectl.sh describe pod -n $NAMESPACE -l app=scanner-v4-db
- command: retry-kubectl.sh describe central.platform.stackrox.io -n $NAMESPACE stackrox-central-services
# Please keep the above lists in sync with pods-debug.yaml and 021-assert-status-conditions.yaml
resourceRefs:
- apiVersion: platform.stackrox.io/v1alpha1
  kind: Central
  name: stackrox-central-services
  ref: central_cr
assertAll:
- celExpr: "central_cr.status.conditions.filter(c, c.type=='Deployed').exists(c, c.status=='True')"
- celExpr: "central_cr.status.conditions.filter(c, c.type=='Initialized').exists(c, c.status=='True')"
- celExpr: "central_cr.status.conditions.filter(c, c.type=='Irreconcilable').exists(c, c.status=='False')"
- celExpr: "central_cr.status.conditions.filter(c, c.type=='ProxyConfigFailed').exists(c, c.status=='False')"
- celExpr: "central_cr.status.conditions.filter(c, c.type=='ReleaseFailed').exists(c, c.status=='False')"
- celExpr: "central_cr.status.conditions.filter(c, c.type=='Deployed').exists(c, c.message.contains('installed'))"
- celExpr: |
    central_cr.status.central.adminPassword.adminPasswordSecretReference
    ==
    (has(central_cr.spec.central.adminPasswordSecret)
       ? central_cr.spec.central.adminPasswordSecret.name
       : 'central-htpasswd')
- celExpr: |
    central_cr.status.productVersion.startsWith('4.9.') ||
    central_cr.status.conditions.filter(c, c.type=='Progressing').exists(c, c.status=='False')
- celExpr: |
    central_cr.status.productVersion.startsWith('4.9.') ||
    central_cr.status.conditions.filter(c, c.type=='Available').exists(c, c.status=='True')
timeout: 1500
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: central
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: central-db
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scanner
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scanner-db
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scanner-v4-indexer
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scanner-v4-matcher
status:
  availableReplicas: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scanner-v4-db
status:
  availableReplicas: 1
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: central-db
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scanner-v4-db
spec:
  accessModes:
  - ReadWriteOnce
