# Test that the operator removes the ownerReference from the central-db-password secret.
# The ownerReference was added in previous versions.
#
# Reason: The deletion of the Central CR will delete the password using garbage collection.
# This is undesirable because, upon Central CR deletion, the operator will NOT delete the
# central-db PVC. So if Central is reinstalled, the operator will reuse the existing PVC,
# but the password that created that DB would be lost.
#
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
# Set up operand image pull secrets for development.
- script: |
    set -eu # shell in CI does not grok -o pipefail
    
    # get the central CR uid
    uid=$(kubectl -n $NAMESPACE get central stackrox-central-services -o jsonpath='{.metadata.uid}')
    
    # add the ownerReference to the secret
    kubectl -n $NAMESPACE patch secret central-db-password --type=json -p='[{"op": "add", "path": "/metadata/ownerReferences", "value": [{"apiVersion": "platform.stackrox.io/v1alpha1", "kind": "Central", "name": "stackrox-central-services", "uid": "'"$uid"'"}]}]'
    
    # add an annotation to central to trigger a reconciliation
    kubectl -n $NAMESPACE patch central stackrox-central-services --type=json -p='[{"op":"add", "path": "/metadata/annotations/foo", "value": "bar"}]'
