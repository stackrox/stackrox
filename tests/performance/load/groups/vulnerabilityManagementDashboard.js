import { group } from 'k6';
import http from 'k6/http';

export function vulnerabilityManagementDashboard(host, headers, tags) {
    group('vulnerability management dashboard', function () {
        http.post(
            `${host}/api/graphql?opname=cvesCount`,
            '{"operationName":"cvesCount","variables":{"query":"Fixable:true"},"query":"query cvesCount($query: String) {\\n  imageVulnerabilityCount\\n  fixableImageVulnerabilityCount: imageVulnerabilityCount(query: $query)\\n  nodeVulnerabilityCount\\n  fixableNodeVulnerabilityCount: nodeVulnerabilityCount(query: $query)\\n  clusterVulnerabilityCount\\n  fixableClusterVulnerabilityCount: clusterVulnerabilityCount(query: $query)\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - imageVulnerabilityCount ($12 = false)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Snoozed = $12)
         *  - fixableImageVulnerabilityCount ($12 = true, $13 = false)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and (image_component_cve_edges.IsFixable = $12 and image_cves.Snoozed = $13))
         *  - nodeVulnerabilityCunt ($2 = false, $3 = false)
         *  select count(distinct(node_cves.Id)) from node_cves inner join node_components_cves_edges on node_cves.Id = node_components_cves_edges.NodeCveId inner join node_component_edges on node_components_cves_edges.NodeComponentId = node_component_edges.NodeComponentId inner join nodes on node_component_edges.NodeId = nodes.Id where (nodes.ClusterId = $1 and (node_cves.Snoozed = $2 and node_cves.Orphaned = $3))
         *  - fixableNodeVulnerabilityCount ($2 = true, $3 = false, $4 = false)
         *  select count(distinct(node_cves.Id)) from node_cves inner join node_components_cves_edges on node_cves.Id = node_components_cves_edges.NodeCveId inner join node_component_edges on node_components_cves_edges.NodeComponentId = node_component_edges.NodeComponentId inner join nodes on node_component_edges.NodeId = nodes.Id where (nodes.ClusterId = $1 and ((node_components_cves_edges.IsFixable = $2 and node_cves.Snoozed = $3) and node_cves.Orphaned = $4))
         *  - clusterVulnerabilityCount ($2 = false)
         *  select count(distinct(cluster_cves.Id)) from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and cluster_cves.Snoozed = $2)
         *  - fixableClusterVulnerabilityCount ($2 = true, $3 = false)
         *  select count(distinct(cluster_cves.Id)) from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and (cluster_cve_edges.IsFixable = $2 and cluster_cves.Snoozed = $3))
         *
         *  DB Queries (no scope)
         *  - imageVulnerabilityCount ($1 = false)
         *  select count(*) from image_cves where image_cves.Snoozed = $1
         *  - fixableImageVulnerabilityCount ($1 = true, $2 = false)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId where (image_component_cve_edges.IsFixable = $1 and image_cves.Snoozed = $2)
         *  - nodeVulnerabilityCount ($1 = false, $2 = false)
         *  select count(*) from node_cves where (node_cves.Snoozed = $1 and node_cves.Orphaned = $2)
         *  - fixableNodeVulnerabilityCount ($1 = true, $2 = false, $3 = false)
         *  select count(distinct(node_cves.Id)) from node_cves inner join node_components_cves_edges on node_cves.Id = node_components_cves_edges.NodeCveId where ((node_components_cves_edges.IsFixable = $1 and node_cves.Snoozed = $2) and node_cves.Orphaned = $3)
         *  - clusterVulnerabilityCount ($1 = false)
         *  select count(*) from cluster_cves where cluster_cves.Snoozed = $1
         *  - fixableClusterVulnerabilityCount ($1 = true, $2 = false)
         *  select count(distinct(cluster_cves.Id)) from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId where (cluster_cve_edges.IsFixable = $1 and cluster_cves.Snoozed = $2)
         */

        http.post(
            `${host}/api/graphql?opname=policiesCount`,
            '{"operationName":"policiesCount","variables":{"query":"Category:Vulnerability Management"},"query":"query policiesCount($query: String) {\\n  policies(query: $query) {\\n    id\\n    alertCount\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=getNodes`,
            '{"operationName":"getNodes","variables":{"query":""},"query":"query getNodes($query: String) {\\n  nodeCount(query: $query)\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - nodeCount
         *  select count(*) from nodes where nodes.ClusterId = $1
         */

        http.post(
            `${host}/api/graphql?opname=getImages`,
            '{"operationName":"getImages","variables":{"query":""},"query":"query getImages($query: String) {\\n  imageCount(query: $query)\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - imageCount
         *  select count(distinct(images.Id)) from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where (deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11))
         */

        http.post(
            `${host}/api/graphql?opname=topRiskyDeployments`,
            '{"operationName":"topRiskyDeployments","variables":{"query":"","vulnQuery":"","entityPagination":{"offset":0,"limit":25,"sortOption":{"field":"Deployment Risk Priority","reversed":false}},"vulnPagination":{"offset":0,"limit":50,"sortOption":{"field":"CVSS","reversed":true}}},"query":"query topRiskyDeployments($query: String, $vulnQuery: String, $entityPagination: Pagination, $vulnPagination: Pagination) {\\n  results: deployments(query: $query, pagination: $entityPagination) {\\n    id\\n    name\\n    clusterName\\n    namespaceName: namespace\\n    priority\\n    plottedVulns: plottedImageVulnerabilities(query: $vulnQuery) {\\n      basicVulnCounter: basicImageVulnerabilityCounter {\\n        all {\\n          total\\n          fixable\\n          __typename\\n        }\\n        __typename\\n      }\\n      vulns: imageVulnerabilities(pagination: $vulnPagination) {\\n        ...vulnFields\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment vulnFields on ImageVulnerability {\\n  id\\n  cve\\n  cvss\\n  severity\\n  __typename\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - deployments
         *  select deployments.Id::text as Deployment_ID from deployments where (deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) order by deployments.RiskScore desc LIMIT 25
         *  - image CVEs
         *  ($12 = false, $13 = q1.deployments.Id)
         *  select distinct(image_cves.Id) as CVE_ID, image_cves.Cvss as cvss from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and (image_cves.Snoozed = $12 and deployments.Id = $13)) order by image_cves.Cvss desc
         *  ($12 = false, $13 = true, $14 = q1.deployments.Id)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and ((image_cves.Snoozed = $12 and image_component_cve_edges.IsFixable = $13) and deployments.Id = $14))
         *  -
         *  ($194 = false, $195 = q1.deployments.Id)
         *  select distinct(image_cves.Id) as CVE_ID, image_cves.Cvss as cvss from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and (((image_cves.Id = $12 or ... or image_cves.Id = $193) and image_cves.Snoozed = $194) and deployments.Id = $195)) order by image_cves.Cvss desc LIMIT 50
         *  ($12 = q2.image_cves.Id)
         *  select "image_cves".serialized from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = ANY($12::text[]))
         *
         *  Note: deployment raw object retrieval is done in the cached store and has therefore no DB footprint
         */

        http.post(
            `${host}/api/graphql?opname=topRiskiestImageVulns`,
            '{"operationName":"topRiskiestImageVulns","variables":{"query":"","pagination":{"offset":0,"limit":8,"sortOption":{"field":"Image Risk Priority","reversed":false}}},"query":"query topRiskiestImageVulns($query: String, $pagination: Pagination) {\\n  results: images(query: $query, pagination: $pagination) {\\n    id\\n    name {\\n      fullName\\n      __typename\\n    }\\n    vulnCounter: imageVulnerabilityCounter {\\n      all {\\n        total\\n        fixable\\n        __typename\\n      }\\n      low {\\n        total\\n        fixable\\n        __typename\\n      }\\n      moderate {\\n        total\\n        fixable\\n        __typename\\n      }\\n      important {\\n        total\\n        fixable\\n        __typename\\n      }\\n      critical {\\n        total\\n        fixable\\n        __typename\\n      }\\n      __typename\\n    }\\n    priority\\n    scan {\\n      scanTime\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - images
         *  select distinct(images.Id) as Image_Sha, images.RiskScore as image_risk_score from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where (deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) order by images.RiskScore desc LIMIT 8
         *  ($23..$30 = q1.images.Id)
         *  select "images".serialized from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or … or deployments.Namespace = $11)) and ((deployments.ClusterId = $12 and (deployments.Namespace = $13 or … or deployments.Namespace = $22)) and (images.Id = $23 or images.Id = $24 or images.Id = $25 or images.Id = $26 or images.Id = $27 or images.Id = $28 or images.Id = $29 or images.Id = $30)))
         *  ($12 = q1.images.Id)
         *  select distinct(images.Id) as Image_Sha, images.LastUpdated as last_updated from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or … or deployments.Namespace = $11)) and images.Id = $12) order by images.LastUpdated asc
         *  - imageVulnerabilityCounter
         *  ($12 = false, $13 = true..false, $14 = q1.images.Id)
         *  select distinct(image_cves.Id) as CVE_ID from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join images on image_component_edges.ImageId = images.Id inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and ((image_cves.Snoozed = $12 and image_component_cve_edges.IsFixable = $13) and images.Id = $14))
         *  ($12 = q4.image_cves.Id)
         *  select "image_cves".serialized from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = ANY($12::text[]))
         */

        http.post(
            `${host}/api/graphql?opname=recentlyDetectedImageVulnerabilities`,
            '{"operationName":"recentlyDetectedImageVulnerabilities","variables":{"query":"CVE Type:IMAGE_CVE","scopeQuery":"","pagination":{"offset":0,"limit":8,"sortOption":{"field":"CVE Created Time","reversed":true}}},"query":"query recentlyDetectedImageVulnerabilities($query: String, $scopeQuery: String, $pagination: Pagination) {\\n  results: imageVulnerabilities(query: $query, pagination: $pagination) {\\n    id\\n    cve\\n    cvss\\n    scoreVersion\\n    deploymentCount\\n    imageCount\\n    isFixable(query: $scopeQuery)\\n    envImpact\\n    createdAt\\n    summary\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - imageVulnerabilities
         *  ($12 = false)
         *  select distinct(image_cves.Id) as CVE_ID, image_cves.CveBaseInfo_CreatedAt as cve_created_time from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Snoozed = $12) order by image_cves.CveBaseInfo_CreatedAt desc LIMIT 8
         *  ($12 = q1.image_cves.Id)
         *  select "image_cves".serialized from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = ANY($12::text[]))
         *  - deploymentCount
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(deployments.Id)) from deployments inner join deployments_containers on deployments.Id = deployments_containers.deployments_Id inner join image_component_edges on deployments_containers.Image_Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or … or deployments.Namespace = $11)) and image_cves.Id = $12)
         *  - imageCount
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(images.Id)) from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12)
         *  - isFixable
         *  ($12 = true, $13 = q1.image_cves.Id)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and (image_component_cve_edges.IsFixable = $12 and image_cves.Id = $13))
         *  -
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(images.Id)) from images inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12)
         */

        http.post(
            `${host}/api/graphql?opname=mostCommonImageVulnerabilities`,
            '{"operationName":"mostCommonImageVulnerabilities","variables":{"query":"","vulnPagination":{"offset":0,"limit":15,"sortOption":{"field":"Deployment Count","reversed":true}}},"query":"query mostCommonImageVulnerabilities($query: String, $vulnPagination: Pagination) {\\n  results: imageVulnerabilities(query: $query, pagination: $vulnPagination) {\\n    id\\n    cve\\n    cvss\\n    scoreVersion\\n    isFixable\\n    deploymentCount\\n    summary\\n    imageCount\\n    lastScanned\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - imageVulnerabilities
         *  ($12 = false)
         *  select image_cves.Id as CVE_ID from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Snoozed = $12) group by image_cves.Id order by count(deployments.Id::text) desc LIMIT 15
         *  ($12 = q1.image_cves.Id)
         *  select "image_cves".serialized from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = ANY($12::text[]))
         *  - isFixable
         *  ($12 = true, $13 = q1.image_cves.Id)
         *  select count(distinct(image_cves.Id)) from image_cves inner join image_component_cve_edges on image_cves.Id = image_component_cve_edges.ImageCveId inner join image_component_edges on image_component_cve_edges.ImageComponentId = image_component_edges.ImageComponentId inner join deployments_containers on image_component_edges.ImageId = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and (image_component_cve_edges.IsFixable = $12 and image_cves.Id = $13))
         *  - deploymentCount
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(deployments.Id)) from deployments inner join deployments_containers on deployments.Id = deployments_containers.deployments_Id inner join image_component_edges on deployments_containers.Image_Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12)
         *  - imageCount
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(images.Id)) from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12)
         *  ($12 = q1.image_cves.Id)
         *  select count(distinct(images.Id)) from images inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12)
         *  - lastScanned
         *  ($12 = q1.image_cves.Id)
         *  select distinct(images.Id) as Image_Sha, images.Scan_ScanTime as image_scan_time from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12) order by images.Scan_ScanTime desc LIMIT 1
         *  ($12 = q1.image_cves.Id)
         *  select distinct(images.Id) as Image_Sha, images.Scan_ScanTime as image_scan_time from images inner join image_component_edges on images.Id = image_component_edges.ImageId inner join image_component_cve_edges on image_component_edges.ImageComponentId = image_component_cve_edges.ImageComponentId inner join image_cves on image_component_cve_edges.ImageCveId = image_cves.Id inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and image_cves.Id = $12) order by images.Scan_ScanTime desc LIMIT 1
         *  ($23 = q6.images.Id)
         *  select "images".serialized from images inner join deployments_containers on images.Id = deployments_containers.Image_Id inner join deployments on deployments_containers.deployments_Id = deployments.Id where ((deployments.ClusterId = $1 and (deployments.Namespace = $2 or ... or deployments.Namespace = $11)) and ((deployments.ClusterId = $12 and (deployments.Namespace = $13 or … or deployments.Namespace = $22)) and images.Id = $23))
         */

        http.post(
            `${host}/api/graphql?opname=deploymentsWithMostSeverePolicyViolations`,
            '{"operationName":"deploymentsWithMostSeverePolicyViolations","variables":{"query":"Category:Vulnerability Management","pagination":{"offset":0,"limit":8}},"query":"query deploymentsWithMostSeverePolicyViolations($query: String, $pagination: Pagination) {\\n  results: deploymentsWithMostSevereViolations(\\n    query: $query\\n    pagination: $pagination\\n  ) {\\n    id\\n    name\\n    clusterName\\n    namespaceName: namespace\\n    failingPolicySeverityCounts {\\n      critical\\n      high\\n      medium\\n      low\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=clustersWithMostClusterVulnerabilities`,
            '{"operationName":"clustersWithMostClusterVulnerabilities","variables":{},"query":"query clustersWithMostClusterVulnerabilities {\\n  results: clusters {\\n    id\\n    name\\n    isGKECluster\\n    isOpenShiftCluster\\n    clusterVulnerabilityCount\\n    clusterVulnerabilities {\\n      cve\\n      isFixable\\n      vulnerabilityType\\n      vulnerabilityTypes\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );
        /** DB Queries
         *  - clusters
         *  select clusters.Id::text as Cluster_ID from clusters where clusters.Id = $1 order by clusters.Name asc
         *  ($2 = q1.clusters.Id)
         *  select "cluster_health_statuses".serialized from cluster_health_statuses inner join clusters on cluster_health_statuses.Id = clusters.Id where (clusters.Id = $1 and cluster_health_statuses.Id = ANY($2::uuid[]))
         *  - clusterVulnerabilityCount
         *  ($2 = false, $3 = q1.clusters.Id)
         *  select count(distinct(cluster_cves.Id)) from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and (cluster_cves.Snoozed = $2 and clusters.Id = $3))
         *  - clusterVulnerabilities
         *  ($2 = false, $3 = q1.clusters.Id)
         *  select distinct(cluster_cves.Id) as CVE_ID from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and (cluster_cves.Snoozed = $2 and clusters.Id = $3))  LIMIT 2147483647
         *  ($2 = q4.cluster_cves.Id)
         *  select "cluster_cves".serialized from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and cluster_cves.Id = ANY($2::text[]))
         *  -
         *  ($2 = true, $3 = q4.cluster_cves.Id, $4 = q1.clusters.Id)
         *  select count(distinct(cluster_cves.Id)) from cluster_cves inner join cluster_cve_edges on cluster_cves.Id = cluster_cve_edges.CveId inner join clusters on cluster_cve_edges.ClusterId = clusters.Id where (clusters.Id = $1 and ((cluster_cve_edges.IsFixable = $2 and cluster_cves.Id = $3) and clusters.Id = $4))
         */

        http.post(
            `${host}/api/graphql?opname=topRiskyNamespaces`,
            '{"operationName":"topRiskyNamespaces","variables":{"query":"","vulnQuery":"","entityPagination":{"offset":0,"limit":25,"sortOption":{"field":"Namespace Risk Priority","reversed":false}},"vulnPagination":{"offset":0,"limit":50,"sortOption":{"field":"CVSS","reversed":true}}},"query":"query topRiskyNamespaces($query: String, $vulnQuery: String, $entityPagination: Pagination, $vulnPagination: Pagination) {\\n  results: namespaces(query: $query, pagination: $entityPagination) {\\n    metadata {\\n      clusterName\\n      name\\n      id\\n      priority\\n      __typename\\n    }\\n    plottedVulns: plottedImageVulnerabilities(query: $vulnQuery) {\\n      basicVulnCounter: basicImageVulnerabilityCounter {\\n        all {\\n          total\\n          fixable\\n          __typename\\n        }\\n        __typename\\n      }\\n      vulns: imageVulnerabilities(pagination: $vulnPagination) {\\n        ...vulnFields\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment vulnFields on ImageVulnerability {\\n  id\\n  cve\\n  cvss\\n  severity\\n  __typename\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=topRiskyImages`,
            '{"operationName":"topRiskyImages","variables":{"query":"","vulnQuery":"","entityPagination":{"offset":0,"limit":25,"sortOption":{"field":"Image Risk Priority","reversed":false}},"vulnPagination":{"offset":0,"limit":50,"sortOption":{"field":"CVSS","reversed":true}}},"query":"query topRiskyImages($query: String, $vulnQuery: String, $entityPagination: Pagination, $vulnPagination: Pagination) {\\n  results: images(query: $query, pagination: $entityPagination) {\\n    id\\n    name {\\n      fullName\\n      __typename\\n    }\\n    priority\\n    plottedVulns: plottedImageVulnerabilities(query: $vulnQuery) {\\n      basicVulnCounter: basicImageVulnerabilityCounter {\\n        all {\\n          total\\n          fixable\\n          __typename\\n        }\\n        __typename\\n      }\\n      vulns: imageVulnerabilities(pagination: $vulnPagination) {\\n        ...vulnFields\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment vulnFields on ImageVulnerability {\\n  id\\n  cve\\n  cvss\\n  severity\\n  __typename\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=topRiskyNodes`,
            '{"operationName":"topRiskyNodes","variables":{"query":"","vulnQuery":"","entityPagination":{"offset":0,"limit":25,"sortOption":{"field":"Node Risk Priority","reversed":false}},"vulnPagination":{"offset":0,"limit":50,"sortOption":{"field":"CVSS","reversed":true}}},"query":"query topRiskyNodes($query: String, $vulnQuery: String, $entityPagination: Pagination, $vulnPagination: Pagination) {\\n  results: nodes(query: $query, pagination: $entityPagination) {\\n    id\\n    name\\n    clusterName\\n    priority\\n    plottedVulns: plottedNodeVulnerabilities(query: $vulnQuery) {\\n      basicVulnCounter: basicNodeVulnerabilityCounter {\\n        all {\\n          total\\n          fixable\\n          __typename\\n        }\\n        __typename\\n      }\\n      vulns: nodeVulnerabilities(pagination: $vulnPagination) {\\n        ...vulnFields\\n        __typename\\n      }\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n\\nfragment vulnFields on NodeVulnerability {\\n  id\\n  cve\\n  cvss\\n  severity\\n  __typename\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=topRiskiestNodeComponents`,
            '{"operationName":"topRiskiestNodeComponents","variables":{"query":"","pagination":{"offset":0,"limit":8,"sortOption":{"field":"Component Risk Priority","reversed":false}}},"query":"query topRiskiestNodeComponents($query: String, $pagination: Pagination) {\\n  results: nodeComponents(query: $query, pagination: $pagination) {\\n    id\\n    name\\n    version\\n    lastScanned\\n    vulnCounter: nodeVulnerabilityCounter {\\n      all {\\n        total\\n        fixable\\n        __typename\\n      }\\n      low {\\n        total\\n        fixable\\n        __typename\\n      }\\n      moderate {\\n        total\\n        fixable\\n        __typename\\n      }\\n      important {\\n        total\\n        fixable\\n        __typename\\n      }\\n      critical {\\n        total\\n        fixable\\n        __typename\\n      }\\n      __typename\\n    }\\n    priority\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=topRiskiestImageComponents`,
            '{"operationName":"topRiskiestImageComponents","variables":{"query":"","pagination":{"offset":0,"limit":8,"sortOption":{"field":"Component Risk Priority","reversed":false}}},"query":"query topRiskiestImageComponents($query: String, $pagination: Pagination) {\\n  results: imageComponents(query: $query, pagination: $pagination) {\\n    id\\n    name\\n    version\\n    lastScanned\\n    vulnCounter: imageVulnerabilityCounter {\\n      all {\\n        total\\n        fixable\\n        __typename\\n      }\\n      low {\\n        total\\n        fixable\\n        __typename\\n      }\\n      moderate {\\n        total\\n        fixable\\n        __typename\\n      }\\n      important {\\n        total\\n        fixable\\n        __typename\\n      }\\n      critical {\\n        total\\n        fixable\\n        __typename\\n      }\\n      __typename\\n    }\\n    priority\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );

        http.post(
            `${host}/api/graphql?opname=topRiskiestNodeVulns`,
            '{"operationName":"topRiskiestNodeVulns","variables":{"query":"","pagination":{"offset":0,"limit":8,"sortOption":{"field":"Node Risk Priority","reversed":false}}},"query":"query topRiskiestNodeVulns($query: String, $pagination: Pagination) {\\n  results: nodes(query: $query, pagination: $pagination) {\\n    id\\n    name\\n    vulnCounter: nodeVulnerabilityCounter {\\n      all {\\n        total\\n        fixable\\n        __typename\\n      }\\n      low {\\n        total\\n        fixable\\n        __typename\\n      }\\n      moderate {\\n        total\\n        fixable\\n        __typename\\n      }\\n      important {\\n        total\\n        fixable\\n        __typename\\n      }\\n      critical {\\n        total\\n        fixable\\n        __typename\\n      }\\n      __typename\\n    }\\n    priority\\n    scan {\\n      scanTime\\n      __typename\\n    }\\n    __typename\\n  }\\n}\\n"}',
            { headers, tags }
        );
    });
}
