package datastore

import (
	"context"

	"github.com/stackrox/rox/central/globaldb"
	"github.com/stackrox/rox/central/globalindex"
	"github.com/stackrox/rox/central/imageintegration/index"
	"github.com/stackrox/rox/central/imageintegration/search"
	"github.com/stackrox/rox/central/imageintegration/store"
	"github.com/stackrox/rox/central/imageintegration/store/bolt"
	"github.com/stackrox/rox/central/imageintegration/store/postgres"
	"github.com/stackrox/rox/pkg/env"
	"github.com/stackrox/rox/pkg/features"
	"github.com/stackrox/rox/pkg/sac"
	"github.com/stackrox/rox/pkg/sync"
	"github.com/stackrox/rox/pkg/utils"
)

var (
	once sync.Once

	dataStore DataStore
)

func initializeIntegrations(storage store.Store) {
	ctx := sac.WithGlobalAccessScopeChecker(context.Background(), sac.AllowAllAccessScopeChecker())
	iis, err := storage.GetAll(ctx)
	utils.CrashOnError(err)
	// If we are starting from scratch in online-mode, add the default image integrations.
	if !env.OfflineModeEnv.BooleanSetting() && len(iis) == 0 {
		// Add default integrations
		for _, ii := range store.DefaultImageIntegrations {
			utils.Must(storage.Upsert(ctx, ii))
		}
	}

	if !features.SourcedAutogeneratedIntegrations.Enabled() {
		for _, ii := range iis {
			if ii.GetAutogenerated() && ii.GetSource() != nil {
				utils.Must(storage.Delete(ctx, ii.GetId()))
			}
		}
	}
}

func initialize() {
	// Create underlying store and datastore.
	var storage store.Store
	var indexer index.Indexer

	if env.PostgresDatastoreEnabled.BooleanSetting() {
		storage = postgres.New(globaldb.GetPostgres())
		indexer = postgres.NewIndexer(globaldb.GetPostgres())
	} else {
		storage = bolt.New(globaldb.GetGlobalDB())
		indexer = index.New(globalindex.GetGlobalTmpIndex())
	}
	initializeIntegrations(storage)
	searcher := search.New(storage, indexer)
	dataStore = New(storage, indexer, searcher)
}

// Singleton provides the interface for non-service external interaction.
func Singleton() DataStore {
	once.Do(initialize)
	return dataStore
}
