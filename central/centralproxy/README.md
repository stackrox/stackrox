# Central Proxy

Central Proxy is a service that provides cluster-local access to StackRox security data with OpenShift RBAC integration. It enables OpenShift Console plugins to access vulnerability data while respecting Kubernetes permissions.

## Architecture

- **Authentication**: Validates OpenShift access tokens via Kubernetes API
- **Authorization**: Uses Kubernetes SubjectAccessReview with virtual GVRs (`security.stackrox.io`)
- **Proxy**: Forwards approved requests to StackRox Central via mTLS
- **Extensible**: Supports both GraphQL (MVP) and REST endpoints

## Configuration

The service is configured via environment variables:

- `CENTRAL_PROXY_PORT`: Port to listen on (default: 8080)
- `CENTRAL_ENDPOINT`: Central API endpoint (default: central.stackrox.svc:443)
- `CERTIFICATE_PATH`: Path to TLS certificates (default: /etc/ssl/certs)
- `NAMESPACE`: Kubernetes namespace (default: stackrox)

## Virtual GVR Permissions

The service uses virtual GVRs under the `security.stackrox.io` API group:

- `images:list` - Access to image data and vulnerabilities
- `vulnerabilities:list` - Access to vulnerability-only queries
- `policies:list` - Access to policy data (future)

## Endpoints

### Health Checks
- `GET /health` - Health check
- `GET /ready` - Readiness check

### GraphQL (MVP)
- `POST /graphql` - GraphQL queries with permission-based filtering

### REST API (Future)
- `GET /api/v1/images` - Image data
- `GET /api/v1/vulnerabilities` - Vulnerability data
- `GET /api/v1/policies` - Policy data

## Security

- mTLS communication with Central
- OpenShift token validation
- Kubernetes RBAC integration
- No persistent data storage

## Development

The service follows standard Go project structure:

```
central/centralproxy/
├── cmd/main.go              # Entry point
├── pkg/
│   ├── server/              # HTTP server and routing
│   ├── auth/                # OpenShift token validation
│   ├── rbac/                # Kubernetes RBAC checks
│   ├── proxy/               # Request forwarding
│   ├── permissions/         # GraphQL query analysis
│   └── client/              # Central API client
├── Dockerfile               # Container image
└── README.md               # This file
```

## Building

```bash
# Build binary
go build -o central-proxy ./cmd

# Build container image
docker build -t central-proxy .
```

## Deployment

The service is deployed automatically by the StackRox installer alongside Sensor in secured clusters. It uses certificates generated by Central and distributed by Sensor.

Required RBAC permissions for the service account:
- SubjectAccessReview creation for permission checks
- Access to the `tls-cert-central-proxy` secret for mTLS certificates