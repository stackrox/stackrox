package storagetov2

import (
	"github.com/pkg/errors"
	v2 "github.com/stackrox/rox/generated/api/v2"
	"github.com/stackrox/rox/generated/storage"
	"github.com/stackrox/rox/pkg/utils"
)

func VirtualMachineVulnerabilities(vulnerabilities []*storage.VirtualMachineVulnerability) []*v2.EmbeddedVulnerability {
	if vulnerabilities == nil {
		return nil
	}

	result := make([]*v2.EmbeddedVulnerability, 0, len(vulnerabilities))
	for _, vulnerability := range vulnerabilities {
		if vulnerability == nil {
			continue
		}
		result = append(result, VirtualMachineVulnerability(vulnerability))
	}

	return result
}

func VirtualMachineVulnerability(vulnerability *storage.VirtualMachineVulnerability) *v2.EmbeddedVulnerability {
	if vulnerability == nil {
		return nil
	}

	result := &v2.EmbeddedVulnerability{}

	result.Cve = vulnerability.GetCveBaseInfo().GetCve()
	result.Summary = vulnerability.GetCveBaseInfo().GetSummary()
	result.Link = vulnerability.GetCveBaseInfo().GetLink()
	result.CvssV3 = CvssV3(vulnerability.GetCveBaseInfo().GetCvssV3())
	result.PublishedOn = vulnerability.GetCveBaseInfo().GetPublishedOn()
	result.LastModified = vulnerability.GetCveBaseInfo().GetLastModified()
	result.FirstSystemOccurrence = vulnerability.GetCveBaseInfo().GetCreatedAt()

	return result
}

func convertVulnerabilityState(state storage.VulnerabilityState) v2.VulnerabilityState {
	switch state {
	case storage.VulnerabilityState_OBSERVED:
		return v2.VulnerabilityState_OBSERVED
	case storage.VulnerabilityState_DEFERRED:
		return v2.VulnerabilityState_DEFERRED
	case storage.VulnerabilityState_FALSE_POSITIVE:
		return v2.VulnerabilityState_FALSE_POSITIVE
	default:
		utils.Should(errors.Errorf("unhandled vulnerability state encountered %s", state))
		return v2.VulnerabilityState_OBSERVED
	}
}

func EmbeddedVulnerabilities(vulns []*storage.EmbeddedVulnerability) []*v2.EmbeddedVulnerability {
	if len(vulns) == 0 {
		return nil
	}

	var ret []*v2.EmbeddedVulnerability
	for _, vuln := range vulns {
		if vuln == nil {
			continue
		}
		ret = append(ret, EmbeddedVulnerability(vuln))
	}

	return ret
}

func EmbeddedVulnerability(vuln *storage.EmbeddedVulnerability) *v2.EmbeddedVulnerability {
	if vuln == nil {
		return nil
	}

	result := &v2.EmbeddedVulnerability{
		Cve:          vuln.GetCve(),
		Summary:      vuln.GetSummary(),
		Link:         vuln.GetLink(),
		Severity:     convertSeverity(vuln.GetSeverity()),
		CvssV3:       CvssV3(vuln.GetCvssV3()),
		PublishedOn:  vuln.GetPublishedOn(),
		LastModified: vuln.GetLastModified(),
	}

	if vuln.GetFixedBy() != "" {
		result.SetFixedBy = &v2.EmbeddedVulnerability_FixedBy{
			FixedBy: vuln.GetFixedBy(),
		}
	}

	return result
}

func CvssV3(cvss *storage.CVSSV3) *v2.CVSSV3 {
	if cvss == nil {
		return nil
	}

	return &v2.CVSSV3{
		Vector:              cvss.GetVector(),
		ExploitabilityScore: cvss.GetExploitabilityScore(),
		ImpactScore:         cvss.GetImpactScore(),
		AttackVector:        convertAttackVectorV3(cvss.GetAttackVector()),
		AttackComplexity:    convertComplexity(cvss.GetAttackComplexity()),
		PrivilegesRequired:  convertPrivileges(cvss.GetPrivilegesRequired()),
		UserInteraction:     convertUserInteraction(cvss.GetUserInteraction()),
		Scope:               convertScope(cvss.GetScope()),
		Confidentiality:     convertImpactV3(cvss.GetConfidentiality()),
		Integrity:           convertImpactV3(cvss.GetIntegrity()),
		Availability:        convertImpactV3(cvss.GetAvailability()),
		Score:               cvss.GetScore(),
		Severity:            convertCVSSV3Severity(cvss.GetSeverity()),
	}
}

func convertSeverity(severity storage.VulnerabilitySeverity) v2.VulnerabilitySeverity {
	return v2.VulnerabilitySeverity(severity)
}

func convertCVSSV3Severity(severity storage.CVSSV3_Severity) v2.CVSSV3_Severity {
	return v2.CVSSV3_Severity(severity)
}

func convertAttackVectorV3(av storage.CVSSV3_AttackVector) v2.CVSSV3_AttackVector {
	return v2.CVSSV3_AttackVector(av)
}

func convertComplexity(ac storage.CVSSV3_Complexity) v2.CVSSV3_Complexity {
	return v2.CVSSV3_Complexity(ac)
}

func convertPrivileges(pr storage.CVSSV3_Privileges) v2.CVSSV3_Privileges {
	return v2.CVSSV3_Privileges(pr)
}

func convertUserInteraction(ui storage.CVSSV3_UserInteraction) v2.CVSSV3_UserInteraction {
	return v2.CVSSV3_UserInteraction(ui)
}

func convertScope(scope storage.CVSSV3_Scope) v2.CVSSV3_Scope {
	return v2.CVSSV3_Scope(scope)
}

func convertImpactV3(impact storage.CVSSV3_Impact) v2.CVSSV3_Impact {
	return v2.CVSSV3_Impact(impact)
}
