package suppressor

import (
	"github.com/stackrox/rox/central/vulnmgmt/vulnerabilityrequest/cache"
	"github.com/stackrox/rox/generated/storage"
	"github.com/stackrox/rox/pkg/logging"
)

type cveSuppressorImpl struct {
	cache cache.VulnReqCache
}

var (
	log = logging.LoggerForModule()
)

func (m *cveSuppressorImpl) EnrichImageWithSuppressedCVEs(image *storage.Image) {
	vulnsMap := m.cache.GetVulnsWithState(image.GetName().GetRegistry(), image.GetName().GetRemote(), image.GetName().GetTag())
	if len(vulnsMap) == 0 {
		return
	}

	log.Infof("vulnsMap = %#v", vulnsMap)
	for _, comp := range image.GetScan().GetComponents() {
		for _, vuln := range comp.GetVulns() {
			vuln.State = vulnsMap[vuln.GetCve()]
			log.Infof("cve state updated %v", vuln)
		}
	}
}
