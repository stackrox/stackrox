package main

import (
	"path"
	"strings"

	"google.golang.org/protobuf/compiler/protogen"
)

func main() {
	protogen.Options{}.Run(func(gen *protogen.Plugin) error {
		for _, f := range gen.Files {
			if !f.Generate {
				continue
			}
			generateFile(gen, f)
		}

		return nil
	})
}

// generateFile generates a _ascii.pb.go file containing gRPC service definitions.
func generateFile(gen *protogen.Plugin, file *protogen.File) {
	filename := file.GeneratedFilenamePrefix + "_compat.pb.go"

	importPath := protogen.GoImportPath(path.Join(
		string(file.GoImportPath),
		string(file.GoPackageName),
	))

	g := gen.NewGeneratedFile(filename, importPath)
	g.P("// Code generated by protoc-gen-go-compat. DO NOT EDIT.")
	g.P()
	g.P("package ", file.GoPackageName)
	g.P()

	for _, m := range file.Messages {
		generateMessage(g, m)
	}
}

func hasSizeField(msg *protogen.Message) bool {
	for _, f := range msg.Fields {
		if f.GoName == "Size" {
			return true
		}
	}

	return false
}

func generateMessage(g *protogen.GeneratedFile, msg *protogen.Message) {
	if msg.Desc.IsMapEntry() {
		return
	}

	s := msg.GoIdent.String()
	name := s[strings.LastIndex(s, ".")+1:]

	g.P()
	if !hasSizeField(msg) {
		g.P("func (m *", name, ") Size() int { return m.SizeVT() }")
	}
	g.P("func (m *", name, ") Clone() *", name, " { return m.CloneVT() }")
	g.P("func (m *", name, ") Marshal() ([]byte, error) { return m.MarshalVT() }")
	g.P("func (m *", name, ") Unmarshal(dAtA []byte) error { return m.UnmarshalVT(dAtA) }")

	g.P()
	for _, m := range msg.Messages {
		generateMessage(g, m)
	}
}
