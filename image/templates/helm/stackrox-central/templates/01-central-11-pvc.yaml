{{- include "srox.init" . -}}

{{ if ._rox.central.persistence._pvcCfg -}}
{{- $pvcCfg := ._rox.central.persistence._pvcCfg -}}
{{- $claimName := $pvcCfg.claimName -}}
{{/* In a multiple namespace setting, storageClassName is generated by globalResourceName */}}
{{- $storageClassName := "" }}
{{- if $pvcCfg.storageClass }}
  {{- if eq $pvcCfg.storageClass "stackrox-gke-ssd" }}
    {{- $storageClassName = include "srox.globalResourceName" (list . "stackrox-gke-ssd") }}
  {{- else }}
    {{- $storageClassName = $pvcCfg.storageClass }}
  {{- end}}
{{- end}}
{{- if $pvcCfg.volume.volumeSpec }}
{{- $pvName := (print $claimName "-pv") -}}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ $pvName }}
  labels:
    {{- include "srox.labels" (list . "persistentvolume" $pvName) | nindent 4 }}
  annotations:
    {{- $annotations := dict -}}
    {{- $_ := include "srox.getAnnotationTemplate" (list . "helm-hook_storage" $annotations) -}}
    {{- include "srox.annotations" (list . "persistentvolume" $pvName $annotations) | nindent 4 }}
spec:
  {{- if $storageClassName }}
  storageClassName: {{ $storageClassName }}
  {{- end}}
  capacity:
    storage: {{ include "srox.formatStorageSize" $pvcCfg.size }}
  accessModes:
    - ReadWriteOnce
  claimRef:
    namespace: {{ .Release.Namespace }}
    name: {{ $claimName }}
  {{- toYaml $pvcCfg.volume.volumeSpec | nindent 2 }}
---
{{- end }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $claimName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "persistentvolumeclaim" $claimName) | nindent 4 }}
  annotations:
    {{- $annotations := dict -}}
    {{- $_ := include "srox.getAnnotationTemplate" (list . "helm-hook_storage" $annotations) -}}
    {{- include "srox.annotations" (list . "persistentvolumeclaim" $claimName $annotations) | nindent 4 }}
spec:
  {{- if $storageClassName }}
  storageClassName: {{ $storageClassName }}
  {{- end }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ include "srox.formatStorageSize" $pvcCfg.size }}
{{- end }}
