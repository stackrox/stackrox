{{- include "srox.init" . -}}

apiVersion: v1
kind: ServiceAccount
metadata:
  name: central
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "serviceaccount" "central") | nindent 4 }}
  annotations:
    {{- include "srox.annotations" (list . "serviceaccount" "central") | nindent 4 }}
    {{- if and (eq ._rox.env.openshift 4) (not ._rox.env.managedServices) }}
    serviceaccounts.openshift.io/oauth-redirectreference.main: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"central"}}'
    serviceaccounts.openshift.io/oauth-redirecturi.main: "sso/providers/openshift/callback"
    {{- end }}
imagePullSecrets:
{{- range $secretName := ._rox.imagePullSecrets._names }}
- name: {{ quote $secretName }}
{{- end }}
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
 namespace: stackrox
 name: central-sts-config-reader
rules:
 - apiGroups: [""]
   resources: ["secrets"]
   resourceNames: ["gcp-cloud-credentials"]
   verbs: ["get", "list", "watch"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
 name: central-sts-config-reader
 namespace: stackrox
subjects:
 - kind: ServiceAccount
   name: central
   namespace: stackrox
roleRef:
 kind: Role
 name: central-sts-config-reader
 apiGroup: rbac.authorization.k8s.io
