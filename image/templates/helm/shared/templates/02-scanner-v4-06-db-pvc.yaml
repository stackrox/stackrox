{{- include "srox.init" . -}}

{{- if ._rox.scannerV4._dbEnabled }}

{{- if ._rox.scannerV4.db.persistence._pvcCfg }}
{{- $pvcCfg := ._rox.scannerV4.db.persistence._pvcCfg -}}
{{- $claimName := $pvcCfg.claimName -}}
{{/* In a multiple namespace setting, storageClassName is generated by globalResourceName */}}
{{- $storageClassName := "" }}
{{- if $pvcCfg.storageClass }}
  {{- if eq $pvcCfg.storageClass "stackrox-gke-ssd" }}
    {{- $storageClassName = include "srox.globalResourceName" (list . "stackrox-gke-ssd") }}
  {{- else }}
    {{- $storageClassName = $pvcCfg.storageClass }}
  {{- end}}
{{- end}}
{{- if $pvcCfg.volume.volumeSpec }}
{{- $pvName := (print $claimName "-pv") -}}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ $pvName }}
  labels:
    {{- include "srox.labels" (list . "persistentvolume" $pvName) | nindent 4 }}
  annotations:
    {{- include "srox.annotations" (list . "persistentvolume" $pvName) | nindent 4 }}
spec:
  {{- if $storageClassName }}
  storageClassName: {{ $storageClassName }}
  {{- end}}
  capacity:
    storage: {{ include "srox.formatStorageSize" $pvcCfg.size }}
  accessModes:
  - ReadWriteOnce
  claimRef:
    namespace: {{ .Release.Namespace }}
    name: {{ $claimName }}
  {{- toYaml $pvcCfg.volume.volumeSpec | nindent 2 }}

---

{{- end }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $claimName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "persistentvolumeclaim" "scanner-v4-db") | nindent 4 }}
    # this is used for backwards compatibility for operator if there are PVCs without annotation
    # owned by the operator it will assume they belong to the deprecated central-db
    target.pvc.stackrox.io: "scanner-v4-db"
  annotations:
    {{- include "srox.annotations" (list . "persistentvolumeclaim" "scanner-v4-db") | nindent 4 }}
spec:
  {{- if $storageClassName }}
  storageClassName: {{ $storageClassName }}
  {{- end }}
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: {{ include "srox.formatStorageSize" $pvcCfg.size }}
{{- end }}

{{- end }}
