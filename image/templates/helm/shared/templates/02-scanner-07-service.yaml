{{- include "srox.init" . -}}

{{- if not ._rox.scanner.disable -}}

apiVersion: v1
kind: Service
metadata:
  name: {{ ._rox.scanner.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "service" ._rox.scanner.name) | nindent 4 }}
  annotations:
    {{- include "srox.annotations" (list . "service" ._rox.scanner.name) | nindent 4 }}
spec:
  ports:
    - name: https-scanner
      port: 8080
      targetPort: 8080
    - name: grpcs-scanner
      port: 8443
      targetPort: 8443
  selector:
    app: {{ ._rox.scanner.name }}
  type: ClusterIP

---

apiVersion: v1
kind: Service
metadata:
  name: {{ ._rox.scanner.name }}-db
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "service" (print ._rox.scanner.name "-db")) | nindent 4 }}
  annotations:
    {{- include "srox.annotations" (list . "service" (print ._rox.scanner.name "-db")) | nindent 4 }}
spec:
  ports:
    - name: tcp-db
      port: 5432
      targetPort: 5432
  selector:
    app: {{ ._rox.scanner.name }}-db
  type: ClusterIP

{{ if ._rox.env.istio }}
---

apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ ._rox.scanner.name }}-internal-no-istio-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "destinationrule" (print ._rox.scanner.name "-internal-no-istio-mtls")) | nindent 4 }}
  annotations:
    stackrox.io/description: "Disable Istio mTLS for ports 8080 and 8443, since StackRox services use built-in mTLS."
    {{- include "srox.annotations" (list . "destinationrule" (print ._rox.scanner.name "-internal-no-istio-mtls")) | nindent 4 }}
spec:
  host: {{ ._rox.scanner.name }}.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    portLevelSettings:
    - port:
        number: 8080
      tls:
        mode: DISABLE
    - port:
        number: 8443
      tls:
        mode: DISABLE

---

apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ ._rox.scanner.name }}-db-internal-no-istio-mtls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "srox.labels" (list . "destinationrule" (print ._rox.scanner.name "-db-internal-no-istio-mtls")) | nindent 4 }}
  annotations:
    stackrox.io/description: "Disable Istio mTLS for port 5432, since StackRox services use built-in mTLS."
    {{- include "srox.annotations" (list . "destinationrule" (print ._rox.scanner.name "-db-internal-no-istio-mtls")) | nindent 4 }}
spec:
  host: {{ ._rox.scanner.name }}-db.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    portLevelSettings:
    - port:
        number: 5432
      tls:
        mode: DISABLE
{{ end }}

{{ end -}}
